---
title: "Brazilian Electoral Data Interpolation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Brazilian Electoral Data Interpolation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>", eval = FALSE)
```

## Overview

This vignette walks through the full workflow for interpolating Brazilian
electoral voting data from polling locations into census tracts using
the `br_*` helper functions.

## Prerequisites

```{r packages}
library(interpElections)

# Brazilian data helpers require:
# install.packages(c("geobr", "censobr", "dplyr", "tidyr",
#                     "data.table", "stringr", "sf", "r5r", "osmextract"))
```

## Quick Start: One-Call Wrapper

The simplest approach uses `interpolate_election_br()`, which handles
everything automatically: census data, electoral data downloads from TSE,
OSM road network, travel times, optimization, and interpolation.

```{r quick}
# Boa Vista 2008 municipal election (Vereador)
result <- interpolate_election_br(
  code_muni = 1400100,
  year = 2008
)

# Result includes census tracts with interpolated candidate votes
plot(result$tracts_sf["CAND_12345"])
```

You can pre-supply a travel time matrix to skip the r5r step:

```{r quick_tt}
result <- interpolate_election_br(
  code_muni = 1400100,
  year = 2008,
  time_matrix = my_tt_matrix
)
```

## Step-by-Step Workflow

For more control, you can call each step individually.

### Step 1: Prepare Population Data

Download Census population by age bracket for a municipality.
The census year is auto-selected based on the election year, or
you can specify it explicitly.

```{r population}
# Example: Belo Horizonte (IBGE code 3106200), Census 2010
pop_data <- br_prepare_population(code_muni = 3106200, year = 2010)
head(pop_data)
```

### Step 2: Prepare Census Tract Shapefiles

```{r tracts}
tracts_sf <- br_prepare_tracts(
  code_muni = 3106200,
  pop_data = pop_data,
  remove_unpopulated = TRUE
)
```

### Step 3: Prepare Electoral Data

Electoral data (voter profiles, candidate votes, turnout) is auto-downloaded
from the official TSE portal when paths are not provided. The IBGE-to-TSE
municipality code conversion uses the bundled `muni_crosswalk` dataset.

```{r electoral}
# Auto-download: just provide codes and year
electoral_data <- br_prepare_electoral(
  code_muni_ibge = "3106200",
  code_muni_tse = "41238",
  uf = "MG",
  year = 2020
)

# Or provide local files (parquet format requires the arrow package)
electoral_data <- br_prepare_electoral(
  code_muni_ibge = "3106200",
  code_muni_tse = "41238",
  uf = "MG",
  year = 2020,
  comparecimento_path = "path/to/detalhe_votacao_secao_2020.parquet",
  votacao_path = "path/to/votacao_secao_coli_2020_VEREADOR.parquet"
)
```

### Step 4: Download OSM Data and Compute Travel Times

```{r travel_times}
# Download OSM road network
r5r_data <- download_r5r_data(
  area_sf = tracts_sf,
  output_dir = "r5r_network/bh/"
)

# Build travel time matrix
tt_matrix <- compute_travel_times(
  zones_sf = tracts_sf,
  points_sf = sf::st_as_sf(electoral_data, coords = c("long", "lat"), crs = 4326),
  network_path = r5r_data$output_dir,
  zone_id = "code_tract",
  point_id = "id",
  mode = "WALK",
  max_trip_duration = 300
)
```

### Step 5: Optimize and Interpolate

```{r optimize}
# Prepare calibration matrices
pop_matrix <- as.matrix(sf::st_drop_geometry(
  tracts_sf[, c("pop_18_20", "pop_21_24", "pop_25_29", "pop_30_39")]
))
source_matrix <- as.matrix(
  electoral_data[, c("votantes_18_20", "votantes_21_24",
                      "votantes_25_29", "votantes_30_39")]
)

# Optimize alpha
result <- optimize_alpha(
  time_matrix = tt_matrix,
  pop_matrix = pop_matrix,
  source_matrix = source_matrix,
  use_gpu = FALSE
)
print(result)

# Interpolate candidate votes
candidate_cols <- grep("^CAND_", names(electoral_data), value = TRUE)
candidate_votes <- as.matrix(electoral_data[, candidate_cols])
interpolated <- idw_interpolate(tt_matrix, result$alpha, candidate_votes)

# Add to census tracts
tracts_sf[, candidate_cols] <- interpolated
```

## Bundled Data

The package includes a crosswalk between IBGE and TSE municipality codes
for all 5,710 Brazilian municipalities:

```{r crosswalk}
data(muni_crosswalk)
head(muni_crosswalk)
#>   code_ibge code_tse uf       nome
#> 1   1200013    01120 AC ACRELÃ‚NDIA
#> 2   1200054    01570 AC ASSIS BRASIL
#> ...
```

## TSE Data Download Helpers

You can also download raw TSE data directly:

```{r tse_helpers}
# Download candidate vote data
votes <- br_download_votes(
  year = 2020, uf = "MG", code_muni_tse = "41238",
  cargo = 13, turno = 1
)

# Download turnout/attendance data
turnout <- br_download_turnout(
  year = 2020, uf = "MG", code_muni_tse = "41238",
  cargo = 13, turno = 1
)
```
