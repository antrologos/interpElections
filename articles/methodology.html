<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Methodology • interpElections</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Methodology">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">interpElections</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/get-started.html">Getting Started</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Technical</h6></li>
    <li><a class="dropdown-item" href="../articles/methodology.html">Methodology</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Advanced</h6></li>
    <li><a class="dropdown-item" href="../articles/working-with-results.html">Working with Results</a></li>
    <li><a class="dropdown-item" href="../articles/diagnostics.html">Diagnostics &amp; Validation</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/antrologos/interpElections/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Methodology</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/antrologos/interpElections/blob/HEAD/vignettes/methodology.Rmd" class="external-link"><code>vignettes/methodology.Rmd</code></a></small>
      <div class="d-none name"><code>methodology.Rmd</code></div>
    </div>

    
    
<p>This vignette walks through the complete interpElections methodology
step by step. Computationally heavy steps show pre-rendered outputs and
figures. Small toy examples (<code>eval = TRUE</code>) can be run
interactively.</p>
<div class="section level2">
<h2 id="part-i-motivation-and-pipeline-overview">Part I: Motivation and Pipeline Overview<a class="anchor" aria-label="anchor" href="#part-i-motivation-and-pipeline-overview"></a>
</h2>
<div class="section level3">
<h3 id="why-sub-municipal-electoral-geography-matters">1. Why Sub-Municipal Electoral Geography Matters<a class="anchor" aria-label="anchor" href="#why-sub-municipal-electoral-geography-matters"></a>
</h3>
<p>Electoral analysis in Brazil faces a fundamental data gap. Votes are
counted at <strong>polling stations</strong> — points on a map, not
geographic zones. The Superior Electoral Court (TSE) publishes detailed
results per station: how many votes each candidate received, turnout
statistics, the age and gender composition of registered voters. But
polling stations do not have defined geographic boundaries. A voter who
lives in tract A and walks past tract B may vote at a station located in
tract C.</p>
<p>Meanwhile, the Census Bureau (IBGE) organizes demographic data by
<strong>census tracts</strong> — small geographic polygons with known
population counts by age, gender, education, and income. These tracts
are the finest spatial unit at which demographic data is available.</p>
<p>The question is: <strong>how did each neighborhood vote?</strong> To
answer this, we need to bridge two incompatible data systems:
point-level electoral data and polygon-level census data. That is what
this package does.</p>
<div class="section level4">
<h4 id="age-structure-as-a-proxy-for-socioeconomic-status">Age structure as a proxy for socioeconomic status<a class="anchor" aria-label="anchor" href="#age-structure-as-a-proxy-for-socioeconomic-status"></a>
</h4>
<p>The bridge between these two systems is the <strong>age
structure</strong> of the population. Age brackets are observed at both
levels: the census records how many people of each age live in each
tract, and the TSE records how many voters of each age voted at each
station.</p>
<p>But why is age structure useful? Because it encodes far more than
just demographics. In Brazilian cities, the age composition of a
neighborhood is strongly correlated with its socioeconomic profile.
Consider two neighborhoods in Rio de Janeiro:</p>
<p><img src="figures/rocinha-copacabana-map.png" alt="" width="100%"></p>
<p><img src="figures/age-pyramids-rocinha-copacabana.png" alt="" width="100%"></p>
<p><strong>Rocinha</strong>, one of Brazil’s largest favelas, has a
young population: large cohorts in the 18–29 age range, tapering off
sharply after 50. <strong>Copacabana</strong>, one of Rio’s wealthiest
neighborhoods, shows the opposite pattern: a narrower base of young
adults and a large proportion of residents over 50. This difference
reflects fertility rates, life expectancy, and migration patterns that
are tightly linked to income, education, and living conditions.</p>
<blockquote>
<p><strong>Census tract codes.</strong> Neighborhoods are defined by
aggregating IBGE 2022 census tracts whose centroids fall within the 2010
neighborhood boundaries (via <code><a href="https://ipeagit.github.io/geobr/reference/read_neighborhood.html" class="external-link">geobr::read_neighborhood()</a></code>).
Rocinha comprises 115 tracts (codes starting with
<code>330455705330</code>, subdistrict 0533); Copacabana comprises 420
tracts (codes starting with <code>330455705100</code>, subdistrict
0510). Tracts shown in green on the map have zero population and are
excluded from the interpolation.</p>
</blockquote>
<p>Because these age signatures differ systematically across
neighborhoods, they carry information about socioeconomic composition —
and, by extension, about voting behavior. The method we describe
exploits this: it finds weights that reproduce the census age structure
at each tract when applied to station-level voter data. If the weights
are correct for demographics, they should also produce good estimates
for vote counts.</p>
</div>
</div>
<div class="section level3">
<h3 id="the-problem-many-to-many-spatial-disaggregation">2. The Problem: Many-to-Many Spatial Disaggregation<a class="anchor" aria-label="anchor" href="#the-problem-many-to-many-spatial-disaggregation"></a>
</h3>
<p>Imagine you are a researcher who wants to know how Copacabana voted
in the 2022 presidential election. The TSE can tell you how each polling
station in the area voted. But several things make this harder than it
seems:</p>
<ul>
<li>
<strong>One station, many neighborhoods</strong>: a school in
Botafogo may receive voters from Botafogo, Laranjeiras, and even from
the Santa Marta favela up the hill. The station’s vote total is a mix of
all these populations.</li>
<li>
<strong>One neighborhood, many stations</strong>: Copacabana voters
may be assigned to polling stations in Copacabana itself, in neighboring
Ipanema, or in Leme. The neighborhood’s voters are split across multiple
stations.</li>
<li>
<strong>No lookup table</strong>: unlike in some countries, there is
no official mapping from residential addresses to polling stations. The
relationship is <strong>many-to-many</strong>, and there is no
administrative data to resolve it.</li>
</ul>
<p>This is not a standard areal interpolation problem. In areal
interpolation, both source and target are polygons, and the overlap area
provides natural weights. Here, the sources are <strong>points</strong>
(stations), not polygons. Area-weighted interpolation does not apply.
Nor is it a simple point-in-polygon assignment: since the mapping is
many-to-many, assigning each tract to its nearest station (Voronoi)
would lose information and produce poor estimates (we demonstrate this
in Section 17).</p>
<div class="section level4">
<h4 id="the-approach-estimating-the-association-structure">The approach: estimating the association structure<a class="anchor" aria-label="anchor" href="#the-approach-estimating-the-association-structure"></a>
</h4>
<p>Our solution estimates the <strong>association structure</strong>
between tracts and stations — a weight matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>W</mi><annotation encoding="application/x-tex">W</annotation></semantics></math>
of dimension
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">[</mo><mi>N</mi><mo>×</mo><mi>M</mi><mo stretchy="true" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">[N \times M]</annotation></semantics></math>
where each entry
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>W</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><annotation encoding="application/x-tex">W_{ij}</annotation></semantics></math>
captures how much station
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>
“serves” tract
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>.</p>
<p>Two fundamental properties are enforced:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Source conservation</strong> (column constraint): each
station distributes exactly 100% of its data. The total votes in the
municipality are preserved exactly:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mo>∑</mo><mi>i</mi></msub><msub><mi>W</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\sum_i W_{ij} = 1</annotation></semantics></math>
for all
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>.</li>
<li>
<strong>Population proportionality</strong> (row constraint): each
tract receives total weight proportional to its population share:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mo>∑</mo><mi>j</mi></msub><msub><mi>W</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>∝</mo><msub><mtext mathvariant="normal">pop</mtext><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\sum_j W_{ij} \propto \text{pop}_i</annotation></semantics></math>.</li>
</ol>
<p>The method <strong>does not assume</strong> a fixed assignment of
voters to stations. Instead, it estimates a smooth probabilistic
mapping, calibrated against known demographic data.</p>
</div>
<div class="section level4">
<h4 id="walking-to-vote-a-behavioral-assumption">Walking to vote: a behavioral assumption<a class="anchor" aria-label="anchor" href="#walking-to-vote-a-behavioral-assumption"></a>
</h4>
<p>The key behavioral assumption is that <strong>voters walk to their
polling stations</strong>. This grounds the spatial model: closer
stations receive more weight because voters are more likely to walk to
them.</p>
<p>This assumption is supported by empirical evidence. Pereira et al.
(2023) studied the effect of free public transit on election day in
Brazilian cities, finding that it increased turnout — implying that
transportation costs (including walking distance) are a meaningful
barrier. Brazilian electoral law requires that voters be assigned to
polling stations near their registered address, reinforcing the spatial
proximity assumption.</p>
<blockquote>
<p>Pereira, R. H. M., Braga, C. K. V., Serra, B., &amp; Nadalin, V.
(2023). “Free public transit and voter turnout.” <em>Available at:</em>
<a href="https://www.urbandemographics.org/files/2023_Pereira_et_al_free_public_transit_voter_turnout.pdf" class="external-link uri">https://www.urbandemographics.org/files/2023_Pereira_et_al_free_public_transit_voter_turnout.pdf</a></p>
</blockquote>
<p>A second important assumption is that <strong>voters reside in the
municipality where they are registered to vote</strong>, which is the
same municipality captured by the census. This residential assumption is
what allows us to use census population data as the target distribution:
the age structure of voters at a polling station should reflect the age
structure of the surrounding population. Without this assumption, the
calibration step would not be valid.</p>
<p>We use realistic <strong>walking travel times</strong> computed on
the OpenStreetMap road network, not straight-line distances. Mountains,
rivers, and the street layout all affect the actual travel time and are
captured by the routing engine (see Section 9).</p>
</div>
</div>
<div class="section level3">
<h3 id="pipeline-overview">3. Pipeline Overview<a class="anchor" aria-label="anchor" href="#pipeline-overview"></a>
</h3>
<p>The full interpolation pipeline has six steps:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Census data</strong>: population counts by age bracket per
tract (<code><a href="../reference/br_prepare_population.html">br_prepare_population()</a></code>)</li>
<li>
<strong>Tract geometries</strong>: census tract polygons from IBGE
(<code><a href="../reference/br_prepare_tracts.html">br_prepare_tracts()</a></code>)</li>
<li>
<strong>Electoral data</strong>: votes, turnout, and voter
demographics per station (<code><a href="../reference/br_prepare_electoral.html">br_prepare_electoral()</a></code>)</li>
<li>
<strong>Travel times</strong>: walking routes from tract
representative points to stations
(<code><a href="../reference/compute_travel_times.html">compute_travel_times()</a></code>)</li>
<li>
<strong>Optimization</strong>: find per-tract decay parameters
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
that minimize demographic mismatch (<code><a href="../reference/optimize_alpha.html">optimize_alpha()</a></code>)</li>
<li>
<strong>Interpolation</strong>: use the column-normalized weight
matrix from optimization (or rebuild with
<code><a href="../reference/compute_weight_matrix.html">compute_weight_matrix()</a></code>) and apply it to any station-level
variable
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>X</mi><mo accent="true">̂</mo></mover><mo>=</mo><mi>W</mi><mo>×</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">\hat{X} = W \times V</annotation></semantics></math>)</li>
</ol>
<p>The convenience function <code><a href="../reference/interpolate_election_br.html">interpolate_election_br()</a></code> wraps
all six steps into a single call for Brazilian municipalities, handling
data downloads, geocoding, and default parameter selection
automatically.</p>
<p><img src="figures/pipeline-stacked-maps.png" alt="" width="100%"></p>
<p>The figure above illustrates the spatial data layers involved.
Starting from the bottom: the municipality boundary, census tracts
colored by population, polling station locations, and the final
interpolated results at the tract level.</p>
</div>
</div>
<div class="section level2">
<h2 id="part-ii-data">Part II: Data<a class="anchor" aria-label="anchor" href="#part-ii-data"></a>
</h2>
<div class="section level3">
<h3 id="census-population-data">4. Census Population Data<a class="anchor" aria-label="anchor" href="#census-population-data"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pop_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/br_prepare_population.html">br_prepare_population</a></span><span class="op">(</span><span class="st">"3170701"</span>, year <span class="op">=</span> <span class="fl">2022</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">pop_data</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code>  code_tract    code_muni pop_00_04 pop_05_09 pop_10_14 pop_15_19 pop_20_24 pop_25_29 pop_30_39 pop_40_49
1 3170701xxxxx  3170701      68        68        62        88        68        58       144       129
2 3170701xxxxx  3170701      37        36        47        38        47        44        83        95
...</code></pre>
<p>The data frame also includes calibration columns that cross gender
(male/female) × 7 age brackets. These <strong>calibration
variables</strong> bridge census tracts and polling stations.</p>
<table class="table">
<colgroup>
<col width="33%">
<col width="33%">
<col width="33%">
</colgroup>
<thead><tr class="header">
<th>Age bracket</th>
<th>Census column</th>
<th>TSE equivalent</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>18–19</td>
<td>
<code>pop_hom_18_19</code>, <code>pop_mul_18_19</code>
</td>
<td>
<code>vot_hom_18_19</code>, <code>vot_mul_18_19</code>
</td>
</tr>
<tr class="even">
<td>20–24</td>
<td>
<code>pop_hom_20_24</code>, <code>pop_mul_20_24</code>
</td>
<td>
<code>vot_hom_20_24</code>, <code>vot_mul_20_24</code>
</td>
</tr>
<tr class="odd">
<td>25–29</td>
<td>
<code>pop_hom_25_29</code>, <code>pop_mul_25_29</code>
</td>
<td>
<code>vot_hom_25_29</code>, <code>vot_mul_25_29</code>
</td>
</tr>
<tr class="even">
<td>30–39</td>
<td>
<code>pop_hom_30_39</code>, <code>pop_mul_30_39</code>
</td>
<td>
<code>vot_hom_30_39</code>, <code>vot_mul_30_39</code>
</td>
</tr>
<tr class="odd">
<td>40–49</td>
<td>
<code>pop_hom_40_49</code>, <code>pop_mul_40_49</code>
</td>
<td>
<code>vot_hom_40_49</code>, <code>vot_mul_40_49</code>
</td>
</tr>
<tr class="even">
<td>50–59</td>
<td>
<code>pop_hom_50_59</code>, <code>pop_mul_50_59</code>
</td>
<td>
<code>vot_hom_50_59</code>, <code>vot_mul_50_59</code>
</td>
</tr>
<tr class="odd">
<td>60–69</td>
<td>
<code>pop_hom_60_69</code>, <code>pop_mul_60_69</code>
</td>
<td>
<code>vot_hom_60_69</code>, <code>vot_mul_60_69</code>
</td>
</tr>
</tbody>
</table>
<p><strong>How the 7 brackets are built.</strong> The TSE voter profile
data records voters in 12 finer age bins (18, 19, 20, 21–24, 25–29,
30–34, 35–39, 40–44, 45–49, 50–54, 55–59, 60–64, 65–69).
<code><a href="../reference/br_prepare_electoral.html">br_prepare_electoral()</a></code> aggregates these into the 7 groups
above so they align with the census age brackets. For the 2022 Census —
which reports a 15–19 group instead of 18–20 — the package applies a
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>/</mi><mn>5</mn></mrow><annotation encoding="application/x-tex">2/5</annotation></semantics></math>
proxy to approximate the 18–19 voting-age share.</p>
<p>These 7 matched brackets are the key insight: they are observed at
<strong>both</strong> levels (census tracts and polling stations),
enabling calibration. The calibration crosses gender × 7 age groups (14
brackets), providing a strong spatial signal because the optimizer must
simultaneously match the spatial distribution of each gender–age
subgroup.</p>
<p><img src="figures/pop-pyramid.png" alt="" width="90%"></p>
</div>
<div class="section level3">
<h3 id="census-tract-geometries">5. Census Tract Geometries<a class="anchor" aria-label="anchor" href="#census-tract-geometries"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tracts_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/br_prepare_tracts.html">br_prepare_tracts</a></span><span class="op">(</span><span class="fl">3170701</span>, <span class="va">pop_data</span><span class="op">)</span></span></code></pre></div>
<p>This downloads tract geometries from <code>geobr</code>, removes
green areas (parks, water bodies with zero population), transforms to
EPSG:5880 (equal-area projection for accurate spatial operations), and
joins the population columns.</p>
<p><img src="figures/tracts-pop-map.png" alt="" width="100%"></p>
<p>Note the urban-rural gradient: small, densely populated tracts in the
city center; large, sparsely populated tracts on the periphery.</p>
</div>
<div class="section level3">
<h3 id="electoral-data-at-polling-stations">6. Electoral Data at Polling Stations<a class="anchor" aria-label="anchor" href="#electoral-data-at-polling-stations"></a>
</h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">electoral</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/br_prepare_electoral.html">br_prepare_electoral</a></span><span class="op">(</span></span>
<span>  code_muni_ibge <span class="op">=</span> <span class="st">"3170701"</span>,</span>
<span>  code_muni_tse  <span class="op">=</span> <span class="st">"54135"</span>,</span>
<span>  uf <span class="op">=</span> <span class="st">"MG"</span>, year <span class="op">=</span> <span class="fl">2022</span>,</span>
<span>  cargo <span class="op">=</span> <span class="st">"presidente"</span>, turno <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  what <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"candidates"</span>, <span class="st">"turnout"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The result contains one row per polling station with:</p>
<ul>
<li>
<strong>Vote columns</strong> (<code>CAND_13</code>,
<code>CAND_22</code>, …): votes per candidate (ballot number as suffix;
95 = blank, 96 = null)</li>
<li>
<strong>Turnout</strong> (<code>QT_COMPARECIMENTO</code>): total
voters who showed up</li>
<li>
<strong>Voter age profiles</strong> (<code>votantes_18_20</code>, …,
<code>votantes_65_69</code>): TSE’s fine-grained age registration
brackets, aggregated to match the 7 census brackets</li>
<li>
<strong>Coordinates</strong> (<code>lat</code>, <code>long</code>):
geocoded polling station locations</li>
<li>
<strong>Column dictionary</strong>:
<code>attr(electoral, "column_dictionary")</code> contains metadata for
each column (type, cargo, candidate name, party)</li>
</ul>
<p>The <code>what</code> parameter controls what gets included:</p>
<ul>
<li>
<code>"candidates"</code>: one column per candidate</li>
<li>
<code>"parties"</code>: aggregated by party (<code>PARTY_PT</code>,
<code>PARTY_PL</code>, …)</li>
<li>
<code>"turnout"</code>: <code>QT_COMPARECIMENTO</code>,
<code>QT_APTOS</code>, <code>QT_ABSTENCOES</code>
</li>
<li>
<code>"demographics"</code>: <code>GENERO_*</code> and
<code>EDUC_*</code> columns</li>
</ul>
<p><img src="figures/electoral-stations-map.png" alt="" width="100%"></p>
</div>
<div class="section level3">
<h3 id="calibration-variables-comparing-source-and-target">7. Calibration Variables: Comparing Source and Target<a class="anchor" aria-label="anchor" href="#calibration-variables-comparing-source-and-target"></a>
</h3>
<p>The calibration variables are the bridge between census tracts and
polling stations. The same age brackets are observed at both levels:</p>
<ul>
<li>
<strong>Census</strong>: “How many people aged 18–20 live in this
tract?” (from IBGE)</li>
<li>
<strong>Electoral</strong>: “How many registered voters aged 18–20
voted at this station?” (from TSE)</li>
</ul>
<p>These are the same age brackets we saw distinguishing Rocinha from
Copacabana in Section 1. The demographic signature that varies across
neighborhoods is precisely what the method uses to calibrate the
weights.</p>
<p><img src="figures/age-pyramids-comparison.png" alt="" width="100%"></p>
<p>The shapes are similar but totals differ: the census counts
residents, the TSE counts registered voters. Not everyone of voting age
is registered, and registration rates vary by age bracket.</p>
<p>The optimization finds alpha values so that the
<strong>interpolated</strong> voter age profiles match the
<strong>census</strong> age profiles at each tract. If the weights are
correct for demographics, they should also be correct for vote
counts.</p>
</div>
</div>
<div class="section level2">
<h2 id="part-iii-geography">Part III: Geography<a class="anchor" aria-label="anchor" href="#part-iii-geography"></a>
</h2>
<div class="section level3">
<h3 id="representative-points-from-tracts-to-routable-origins">8. Representative Points: From Tracts to Routable Origins<a class="anchor" aria-label="anchor" href="#representative-points-from-tracts-to-routable-origins"></a>
</h3>
<p>Routing engines need <strong>point-to-point</strong> queries, but
tracts are polygons. We need a single representative point per tract.
Three methods are available:</p>
<table class="table">
<colgroup>
<col width="33%">
<col width="33%">
<col width="33%">
</colgroup>
<thead><tr class="header">
<th>Method</th>
<th>Function</th>
<th>Guarantee</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>"centroid"</code></td>
<td><code><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">sf::st_centroid()</a></code></td>
<td>Fast. May fall outside concave polygons.</td>
</tr>
<tr class="even">
<td><code>"point_on_surface"</code></td>
<td><code><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">sf::st_point_on_surface()</a></code></td>
<td>Guaranteed inside. Default.</td>
</tr>
<tr class="odd">
<td><code>"pop_weighted"</code></td>
<td>WorldPop raster lookup</td>
<td>Most populated cell. Best for large tracts.</td>
</tr>
</tbody>
</table>
<p>The choice of representative point matters most for <strong>large,
irregularly shaped tracts</strong> in rural and peri-urban areas.
Consider the southern periphery of São Paulo, where census tracts extend
over several square kilometers of mixed urban and forested land:</p>
<p><img src="figures/rep-points-saopaulo-comparison.png" alt="" width="100%"></p>
<p>The three-panel comparison shows the same set of large tracts in
south São Paulo. The red dots (centroids) frequently fall in uninhabited
areas — in the middle of Mata Atlântica forest or in empty fields. The
blue dots (point on surface) are guaranteed to be inside the polygon,
but may still be far from where people actually live. The green dots
(pop-weighted) use the WorldPop population raster to find the most
densely populated cell within each tract, placing the representative
point where residents actually are.</p>
<p><img src="figures/rep-points-zoom-inset.png" alt="" width="80%"></p>
<p>Zooming into the largest tract, the centroid falls in dense forest
while the pop-weighted point correctly identifies the settlement area.
This difference can affect travel time calculations by tens of
minutes.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pts_pos</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_representative_points.html">compute_representative_points</a></span><span class="op">(</span><span class="va">tracts_sf</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"point_on_surface"</span><span class="op">)</span></span>
<span><span class="va">pts_pop</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_representative_points.html">compute_representative_points</a></span><span class="op">(</span><span class="va">tracts_sf</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"pop_weighted"</span><span class="op">)</span></span></code></pre></div>
<p>The <code>pop_weighted</code> method downloads the WorldPop Brazil
Constrained 2020 raster (~48 MB, cached) and finds the raster cell with
the highest population density within each tract.</p>
<p>The <code>min_area_for_pop_weight</code> parameter (default: 1 km²)
controls the threshold: tracts smaller than this use
<code>point_on_surface</code> regardless of the chosen method, since
small urban tracts are dense enough that any interior point is a
reasonable proxy.</p>
</div>
<div class="section level3">
<h3 id="travel-times-building-the-distance-matrix">9. Travel Times: Building the Distance Matrix<a class="anchor" aria-label="anchor" href="#travel-times-building-the-distance-matrix"></a>
</h3>
<div class="section level4">
<h4 id="why-walking-travel-time">9.1 Why walking travel time?<a class="anchor" aria-label="anchor" href="#why-walking-travel-time"></a>
</h4>
<p>In Brazil, voters are assigned to polling stations near their
registered address. On election day, most voters <strong>walk</strong>
to their polling station. This is not merely an assumption of
convenience — it is grounded in the geographic design of the Brazilian
electoral system and in empirical evidence.</p>
<p>Pereira et al. (2023) studied the introduction of free public transit
on election days in Brazilian cities. Their finding that free transit
significantly increased turnout implies that the <strong>cost of getting
to the polls</strong> — primarily walking distance — is a real barrier
that affects participation. If distance matters for whether people vote
at all, it certainly matters for <em>where</em> they vote.</p>
<p>We therefore use <strong>realistic walking travel times</strong>
computed on the OpenStreetMap road network, not Euclidean
(straight-line) distances. The routing engine (r5r) accounts for the
actual street layout, elevation, one-way streets, pedestrian paths, and
physical barriers.</p>
</div>
<div class="section level4">
<h4 id="euclidean-distance-vs--walking-routes">9.2 Euclidean distance vs. walking routes<a class="anchor" aria-label="anchor" href="#euclidean-distance-vs--walking-routes"></a>
</h4>
<p>Why not just use straight-line distance? Because geography creates
dramatic discrepancies between Euclidean distance and actual walking
time. Two examples:</p>
<p><strong>Example 1: Mountain barrier (Rio de Janeiro)</strong></p>
<p>A point in the Botafogo neighborhood lies at the base of the
Corcovado/Sumaré hills. A polling station in Laranjeiras sits on the
other side. In a straight line, the distance is modest — but the walking
route must navigate around the steep terrain:</p>
<p><img src="figures/routes-rj-botafogo-laranjeiras.png" alt="" width="100%"></p>
<p>The solid blue line shows the actual walking route computed by r5r on
the OSM road network. The dotted red line shows the straight-line
distance. In mountainous terrain, these can differ by a factor of
3–5x.</p>
<p><strong>Example 2: Water barrier (Recife)</strong></p>
<p>A point in the Boa Vista neighborhood and a destination in the
Brasília Teimosa peninsula are separated by Recife’s waterways. The
walking route must navigate around the estuary and cross bridges, adding
significant distance compared to the straight line.</p>
<p><img src="figures/routes-recife-water.png" alt="" width="100%"></p>
<p><strong>Example 3: Water barrier (Florianópolis)</strong></p>
<p>Florianópolis, capital of Santa Catarina, is split between the
mainland and an island in the Atlantic. A point in Coqueiros (mainland)
and a destination at Costeira do Pirajubaé (island) are separated by the
bay. The walking route must detour to one of the bridges connecting the
two sides:</p>
<p><img src="figures/routes-florianopolis-water.png" alt="" width="100%"></p>
<p>These examples illustrate why Euclidean distance is a poor proxy for
actual accessibility — and why the routing engine matters.</p>
</div>
<div class="section level4">
<h4 id="building-the-travel-time-matrix">9.3 Building the travel time matrix<a class="anchor" aria-label="anchor" href="#building-the-travel-time-matrix"></a>
</h4>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">time_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_travel_times.html">compute_travel_times</a></span><span class="op">(</span></span>
<span>  tracts_sf <span class="op">=</span> <span class="va">tracts_sf</span>,</span>
<span>  points_sf <span class="op">=</span> <span class="va">electoral_sf</span>,</span>
<span>  network_path <span class="op">=</span> <span class="va">network_path</span>,</span>
<span>  tract_id <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>  point_id <span class="op">=</span> <span class="st">"id"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This builds an <strong>[N tracts × M stations] matrix</strong> of
walking travel times in minutes, using the r5r routing engine on
OpenStreetMap data.</p>
<ul>
<li>
<strong>Origins</strong>: representative points (from Section
8)</li>
<li>
<strong>Destinations</strong>: polling station coordinates</li>
<li>
<strong>Mode</strong>: walking (default), configurable</li>
<li>
<strong>Max trip duration</strong>: 300 minutes; unreachable pairs
get this value</li>
</ul>
<p>The OSM data is downloaded via <code><a href="../reference/download_r5r_data.html">download_r5r_data()</a></code>,
which fetches state-level <code>.pbf</code> files and clips them to the
municipality bounding box using osmium.</p>
<p><img src="figures/tt-heatmap.png" alt="" width="90%"></p>
<p>The heatmap shows spatial structure: a block-diagonal pattern where
nearby tract-station pairs have short travel times.</p>
<p><img src="figures/tt-accessibility-map.png" alt="" width="100%"></p>
<p>Tracts in the center have short travel times to the nearest station;
peripheral tracts are farther away.</p>
<p><strong>The offset</strong>: before applying the IDW kernel, we add 1
to all travel times (<code>time_matrix + 1</code>) to avoid singularity
when
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">t = 0</annotation></semantics></math>.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="part-iv-the-weight-matrix">Part IV: The Weight Matrix<a class="anchor" aria-label="anchor" href="#part-iv-the-weight-matrix"></a>
</h2>
<div class="section level3">
<h3 id="the-idw-kernel-turning-distance-into-influence">10. The IDW Kernel: Turning Distance into Influence<a class="anchor" aria-label="anchor" href="#the-idw-kernel-turning-distance-into-influence"></a>
</h3>
<div class="section level4">
<h4 id="intuition-gravitational-pull">Intuition: gravitational pull<a class="anchor" aria-label="anchor" href="#intuition-gravitational-pull"></a>
</h4>
<p>Think of each polling station as exerting a “gravitational pull” on
nearby tracts. Closer stations pull harder. The IDW (Inverse Distance
Weighting) kernel translates this intuition into numbers: given a travel
time between a tract and a station, it produces a weight that decreases
with distance.</p>
</div>
<div class="section level4">
<h4 id="a-concrete-example">A concrete example<a class="anchor" aria-label="anchor" href="#a-concrete-example"></a>
</h4>
<p>Suppose a tract has three nearby stations at 5, 12, and 30 minutes
walking distance. How much should each station contribute to this
tract’s estimate? With a decay parameter
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">\alpha = 2</annotation></semantics></math>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">12</span>, <span class="fl">30</span><span class="op">)</span>  <span class="co"># travel times in minutes</span></span>
<span><span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="va">raw_weights</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">tt</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="va">alpha</span><span class="op">)</span></span>
<span><span class="va">normalized</span> <span class="op">&lt;-</span> <span class="va">raw_weights</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">raw_weights</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Travel times:"</span>, <span class="va">tt</span>, <span class="st">"minutes\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Travel times: 5 12 30 minutes</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Raw weights: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">raw_weights</span>, <span class="fl">5</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Raw weights:  0.02778 0.00592 0.00104</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Normalized:  "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">normalized</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Normalized:   0.8 0.17 0.03</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"The 5-min station gets"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">normalized</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span>,</span>
<span>    <span class="st">"% of this tract's weight\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; The 5-min station gets 80 % of this tract's weight</span></span></code></pre></div>
<p>The nearest station (5 min) gets the lion’s share of the weight. The
30-minute station contributes very little.</p>
</div>
<div class="section level4">
<h4 id="the-formula">The formula<a class="anchor" aria-label="anchor" href="#the-formula"></a>
</h4>
<p>The raw weight between tract
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
and station
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>W</mi><mrow><mi>i</mi><mi>j</mi></mrow><mtext mathvariant="normal">raw</mtext></msubsup><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>t</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>+</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><msub><mi>α</mi><mi>i</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">W^{\text{raw}}_{ij} = (t_{ij} + 1)^{-\alpha_i}</annotation></semantics></math></p>
<p>where:</p>
<ul>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><annotation encoding="application/x-tex">t_{ij}</annotation></semantics></math>:
travel time from tract
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
to station
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>
(minutes)</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>α</mi><mi>i</mi></msub><annotation encoding="application/x-tex">\alpha_i</annotation></semantics></math>:
decay parameter for tract
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
(to be optimized)</li>
</ul>
</div>
<div class="section level4">
<h4 id="how-alpha-controls-the-decay">How alpha controls the decay<a class="anchor" aria-label="anchor" href="#how-alpha-controls-the-decay"></a>
</h4>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tt_range</span> <span class="op">&lt;-</span> <span class="fl">0</span><span class="op">:</span><span class="fl">60</span></span>
<span><span class="va">alphas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">decay_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">alphas</span>, <span class="kw">function</span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">tt_range</span>, weight <span class="op">=</span> <span class="op">(</span><span class="va">tt_range</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="va">a</span><span class="op">)</span>,</span>
<span>             alpha <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"alpha = "</span>, <span class="va">a</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">decay_df</span><span class="op">$</span><span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">decay_df</span><span class="op">$</span><span class="va">alpha</span>,</span>
<span>                          levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"alpha = "</span>, <span class="va">alphas</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">decay_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">weight</span>, color <span class="op">=</span> <span class="va">alpha</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Weight Decay Curves"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Higher alpha = steeper decay = more concentrated weights"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Travel time (minutes)"</span>, y <span class="op">=</span> <span class="st">"Weight (log scale)"</span>,</span>
<span>       color <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>        legend.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span></span></code></pre></div>
<p><img src="methodology_files/figure-html/weight-decay-1.png" alt="" width="100%"></p>
<ul>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi><mo>=</mo><mn>0.5</mn></mrow><annotation encoding="application/x-tex">\alpha = 0.5</annotation></semantics></math>:
nearly flat — all stations contribute almost equally</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">\alpha = 2</annotation></semantics></math>:
moderate — stations within 10 minutes dominate</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi><mo>=</mo><mn>10</mn></mrow><annotation encoding="application/x-tex">\alpha = 10</annotation></semantics></math>:
steep cliff — only the nearest station matters</li>
</ul>
</div>
<div class="section level4">
<h4 id="why-per-tract-alpha">Why per-tract alpha?<a class="anchor" aria-label="anchor" href="#why-per-tract-alpha"></a>
</h4>
<p>A single global
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
cannot capture the heterogeneity of urban geography. Urban centers have
many overlapping station catchments — these tracts need a low
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
to spread weight across several stations. Isolated peripheral tracts
with one nearby station need a high
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
to concentrate weight. The optimizer finds the best
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
for each tract independently.</p>
</div>
</div>
<div class="section level3">
<h3 id="why-single-sided-standardization-fails">11. Why Single-Sided Standardization Fails<a class="anchor" aria-label="anchor" href="#why-single-sided-standardization-fails"></a>
</h3>
<p>Before describing the column normalization approach used by the
package, let us understand why simpler row-based approaches do not work.
We need to normalize the raw weight matrix so that the weights sum to
meaningful quantities. There are two natural choices — and only column
normalization provides the guarantee we need.</p>
<div class="section level4">
<h4 id="column-only-standardization">11.1 Column-only standardization<a class="anchor" aria-label="anchor" href="#column-only-standardization"></a>
</h4>
<p>The first approach: divide each column by its sum so that each
station distributes 100% of its data:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>W</mi><mrow><mi>i</mi><mi>j</mi></mrow><mtext mathvariant="normal">col</mtext></msubsup><mo>=</mo><mfrac><msubsup><mi>W</mi><mrow><mi>i</mi><mi>j</mi></mrow><mtext mathvariant="normal">raw</mtext></msubsup><mrow><munder><mo>∑</mo><mi>i</mi></munder><msubsup><mi>W</mi><mrow><mi>i</mi><mi>j</mi></mrow><mtext mathvariant="normal">raw</mtext></msubsup></mrow></mfrac></mrow><annotation encoding="application/x-tex">W^{\text{col}}_{ij} = \frac{W^{\text{raw}}_{ij}}{\sum_i W^{\text{raw}}_{ij}}</annotation></semantics></math></p>
<p>Column sums = 1 (<strong>source conservation</strong>: every vote is
distributed exactly once). But there is no constraint on row sums.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Toy example: 5 tracts, 3 stations</span></span>
<span><span class="va">tt_toy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,  <span class="fl">10</span>, <span class="fl">25</span>, <span class="fl">30</span>, <span class="fl">50</span>,   <span class="co"># station 1: close to tract 1</span></span>
<span>    <span class="fl">15</span>,  <span class="fl">3</span>, <span class="fl">12</span>, <span class="fl">28</span>, <span class="fl">45</span>,   <span class="co"># station 2: close to tract 2</span></span>
<span>    <span class="fl">40</span>, <span class="fl">35</span>, <span class="fl">20</span>,  <span class="fl">5</span>,  <span class="fl">8</span><span class="op">)</span>,  <span class="co"># station 3: close to tracts 4-5</span></span>
<span>  nrow <span class="op">=</span> <span class="fl">5</span>, ncol <span class="op">=</span> <span class="fl">3</span></span>
<span><span class="op">)</span></span>
<span><span class="va">pop_toy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">300</span>, <span class="fl">150</span>, <span class="fl">200</span>, <span class="fl">250</span><span class="op">)</span>  <span class="co"># population per tract</span></span>
<span></span>
<span><span class="va">alpha_toy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">W_raw</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">tt_toy</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="va">alpha_toy</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Column standardize</span></span>
<span><span class="va">W_col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">W_raw</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">W_raw</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Column sums (should be 1 — OK):\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Column sums (should be 1 — OK):</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">W_col</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1 1 1</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nRow sums (uncontrolled — BAD):\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Row sums (uncontrolled — BAD):</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">W_col</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.9751 0.9300 0.1439 0.6594 0.2917</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nPopulation shares (what rows should look like):\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Population shares (what rows should look like):</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">pop_toy</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">pop_toy</span><span class="op">)</span> <span class="op">*</span> <span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.30 0.90 0.45 0.60 0.75</span></span></code></pre></div>
<p>Tract 1 has only 10% of the population but receives a
disproportionate share because it is close to station 1. Municipal
totals are preserved, but the <em>distribution</em> across tracts is
wrong.</p>
</div>
<div class="section level4">
<h4 id="row-only-standardization">11.2 Row-only standardization<a class="anchor" aria-label="anchor" href="#row-only-standardization"></a>
</h4>
<p>The opposite approach: normalize rows to match population shares.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Row standardize to population-proportional targets</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">tt_toy</span><span class="op">)</span></span>
<span><span class="va">row_targets_toy</span> <span class="op">&lt;-</span> <span class="va">pop_toy</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">pop_toy</span><span class="op">)</span> <span class="op">*</span> <span class="va">m</span></span>
<span></span>
<span><span class="va">W_row</span> <span class="op">&lt;-</span> <span class="va">W_raw</span> <span class="op">*</span> <span class="op">(</span><span class="va">row_targets_toy</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">W_raw</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Row sums (should match population targets — OK):\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Row sums (should match population targets — OK):</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">W_row</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.30 0.90 0.45 0.60 0.75</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nColumn sums (should be 1 — BAD):\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Column sums (should be 1 — BAD):</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">W_row</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.5038 1.1226 1.3736</span></span></code></pre></div>
<p>Now the rows are correct, but the column sums are wrong. Some
stations “distribute” more than 100% of their votes, others less than
100%. The municipal total is no longer conserved: if we multiply these
weights by vote counts, we get more (or fewer) total votes than actually
existed.</p>
</div>
<div class="section level4">
<h4 id="the-choice-column-normalization">The choice: column normalization<a class="anchor" aria-label="anchor" href="#the-choice-column-normalization"></a>
</h4>
<ul>
<li>Column-only: preserves totals (<strong>source conservation</strong>)
— every vote is distributed exactly once. The spatial
<em>distribution</em> across tracts is governed by the optimized alpha
parameters, which are calibrated against census demographics.</li>
<li>Row-only: distributes correctly but does not preserve totals.</li>
</ul>
<p><strong>Column normalization is the right choice</strong> because
source conservation is the non-negotiable constraint: we must not create
or destroy votes. The alpha optimization (Section 13) takes care of
making the row-side distribution match census demographics as closely as
possible.</p>
</div>
</div>
<div class="section level3">
<h3 id="column-normalization-source-conservation">12. Column Normalization: Source Conservation<a class="anchor" aria-label="anchor" href="#column-normalization-source-conservation"></a>
</h3>
<div class="section level4">
<h4 id="the-idea-preserving-station-totals">12.1 The idea: preserving station totals<a class="anchor" aria-label="anchor" href="#the-idea-preserving-station-totals"></a>
</h4>
<p>The core constraint is <strong>source conservation</strong>: each
polling station must distribute exactly 100% of its data. If a station
recorded 500 votes, the interpolation must assign exactly 500 votes
across all tracts — no more, no less.</p>
<p>Column normalization enforces this directly: divide each column of
the raw weight matrix by its sum so that each station’s weights sum to
1.</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mfrac><msub><mi>K</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mrow><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>K</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow></mfrac></mrow><annotation encoding="application/x-tex">W_{ij} = \frac{K_{ij}}{\sum_i K_{ij}}</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>t</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>+</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><msub><mi>α</mi><mi>i</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">K_{ij} = (t_{ij} + 1)^{-\alpha_i}</annotation></semantics></math>
is the IDW kernel from Section 10.</p>
</div>
<div class="section level4">
<h4 id="worked-example">12.2 Worked example<a class="anchor" aria-label="anchor" href="#worked-example"></a>
</h4>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Using the toy example from Section 11</span></span>
<span><span class="co"># W_raw is already defined: 5 tracts, 3 stations</span></span>
<span><span class="va">W_col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">W_raw</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">W_raw</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Column sums (should be 1 — source conservation):\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Column sums (should be 1 — source conservation):</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">W_col</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1 1 1</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nRow sums (governed by alpha — not explicitly constrained):\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Row sums (governed by alpha — not explicitly constrained):</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">W_col</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.9751 0.9300 0.1439 0.6594 0.2917</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nWeight matrix:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Weight matrix:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">W_col</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;        [,1]   [,2]   [,3]</span></span>
<span><span class="co">#&gt; [1,] 0.9087 0.0528 0.0136</span></span>
<span><span class="co">#&gt; [2,] 0.0676 0.8448 0.0176</span></span>
<span><span class="co">#&gt; [3,] 0.0121 0.0800 0.0518</span></span>
<span><span class="co">#&gt; [4,] 0.0085 0.0161 0.6348</span></span>
<span><span class="co">#&gt; [5,] 0.0031 0.0064 0.2821</span></span></code></pre></div>
<p>Each station distributes exactly 100% of its data. The distribution
across tracts is determined by the IDW kernel: tracts closer to a
station receive more weight. The <strong>alpha optimization</strong>
(Section 13) adjusts the decay parameters so that the resulting
tract-level estimates match census demographics as closely as
possible.</p>
<p><strong>Key properties</strong>:</p>
<ul>
<li>
<strong>Source conservation</strong>: column sums are exactly 1</li>
<li>
<strong>Non-negative</strong>: all weights are non-negative</li>
<li>
<strong>Deterministic</strong>: no iterative procedure, just a
single division</li>
<li>Unreachable tracts (all-zero rows) remain zero and are flagged</li>
</ul>
</div>
<div class="section level4">
<h4 id="per-bracket-column-normalization">12.3 Per-Bracket Column Normalization<a class="anchor" aria-label="anchor" href="#per-bracket-column-normalization"></a>
</h4>
<div class="section level5">
<h5 id="the-problem-age-groups-have-different-geographies">The problem: age groups have different geographies<a class="anchor" aria-label="anchor" href="#the-problem-age-groups-have-different-geographies"></a>
</h5>
<p>Think about the spatial distribution of voters by age. Young adults
(18–24) cluster near universities, cheap rental apartments, and transit
corridors. Elderly voters (60–69) concentrate in established
neighborhoods, retirement communities, and areas with healthcare
facilities. These spatial patterns differ substantially — yet a single
weight matrix must allocate <em>all</em> age groups simultaneously.</p>
<p>With <strong>aggregate</strong> column normalization, the weight
matrix has one set of weights for all age brackets. The optimizer must
find one set of weights that simultaneously matches multiple different
demographic distributions. This is an inherent compromise: weights that
correctly distribute 18–20 year-olds may systematically misallocate
60–69 year-olds, and vice versa.</p>
</div>
<div class="section level5">
<h5 id="the-per-bracket-extension">The per-bracket extension<a class="anchor" aria-label="anchor" href="#the-per-bracket-extension"></a>
</h5>
<p><strong>Per-bracket column normalization</strong> addresses this by
building a separate column-normalized weight matrix for each demographic
bracket
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>=</mo><mn>1</mn><mo>,</mo><mi>…</mi><mo>,</mo><mi>K</mi></mrow><annotation encoding="application/x-tex">k = 1, \ldots, K</annotation></semantics></math>.
Instead of one weight matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>W</mi><annotation encoding="application/x-tex">W</annotation></semantics></math>,
we build
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>K</mi><annotation encoding="application/x-tex">K</annotation></semantics></math>
bracket-specific matrices
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></msup><mo>,</mo><mi>…</mi><mo>,</mo><msup><mi>W</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>K</mi><mo stretchy="true" form="postfix">)</mo></mrow></msup></mrow><annotation encoding="application/x-tex">W^{(1)}, \ldots, W^{(K)}</annotation></semantics></math>,
each column-normalized independently:</p>
<p><strong>For each bracket
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>:</strong></p>
<ol style="list-style-type: decimal">
<li>
<strong>Compute the IDW kernel</strong>:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>K</mi><mrow><mi>i</mi><mi>j</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>k</mi><mo stretchy="true" form="postfix">)</mo></mrow></msubsup><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>t</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>+</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><msub><mi>α</mi><mi>i</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">K^{(k)}_{ij} = (t_{ij} + 1)^{-\alpha_{i}}</annotation></semantics></math>
(same kernel for all brackets, since alpha is shared)</li>
<li>
<strong>Column-normalize</strong>:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>W</mi><mrow><mi>i</mi><mi>j</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>k</mi><mo stretchy="true" form="postfix">)</mo></mrow></msubsup><mo>=</mo><msubsup><mi>K</mi><mrow><mi>i</mi><mi>j</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>k</mi><mo stretchy="true" form="postfix">)</mo></mrow></msubsup><mi>/</mi><msub><mo>∑</mo><mi>i</mi></msub><msubsup><mi>K</mi><mrow><mi>i</mi><mi>j</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>k</mi><mo stretchy="true" form="postfix">)</mo></mrow></msubsup></mrow><annotation encoding="application/x-tex">W^{(k)}_{ij} = K^{(k)}_{ij} / \sum_i K^{(k)}_{ij}</annotation></semantics></math>
</li>
</ol>
<p><strong>Aggregate:</strong></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mtext mathvariant="normal">total</mtext></msub><mo>=</mo><mfrac><mn>1</mn><mi>K</mi></mfrac><munderover><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>K</mi></munderover><msup><mi>W</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>k</mi><mo stretchy="true" form="postfix">)</mo></mrow></msup></mrow><annotation encoding="application/x-tex">W_{\text{total}} = \frac{1}{K} \sum_{k=1}^{K} W^{(k)}</annotation></semantics></math></p>
<p>followed by a final column normalization to enforce source
conservation (each station distributes exactly 100% of its data).</p>
</div>
<div class="section level5">
<h5 id="why-this-works">Why this works<a class="anchor" aria-label="anchor" href="#why-this-works"></a>
</h5>
<p>Each bracket’s column-normalized weights distribute that bracket’s
station-level data across tracts proportionally to the IDW kernel. The
alpha optimization (Section 13) adjusts the decay parameters so that the
resulting interpolated demographics match the census demographics across
all brackets simultaneously. The per-bracket structure allows the loss
function to separately account for each age group’s spatial pattern.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Bracket 1 ("young"): concentrated near station 1</span></span>
<span><span class="co"># Bracket 2 ("old"): concentrated near station 3</span></span>
<span><span class="va">pop_young</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">60</span>, <span class="fl">100</span>, <span class="fl">50</span>, <span class="fl">30</span>, <span class="fl">20</span><span class="op">)</span>   <span class="co"># young pop per tract</span></span>
<span><span class="va">pop_old</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">40</span>, <span class="fl">200</span>, <span class="fl">100</span>, <span class="fl">170</span>, <span class="fl">230</span><span class="op">)</span> <span class="co"># old pop per tract</span></span>
<span></span>
<span><span class="va">src_young</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">150</span>, <span class="fl">70</span>, <span class="fl">40</span><span class="op">)</span>  <span class="co"># young voters per station</span></span>
<span><span class="va">src_old</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">330</span>, <span class="fl">310</span><span class="op">)</span> <span class="co"># old voters per station</span></span>
<span></span>
<span><span class="co"># Per-bracket column normalization: each bracket uses the same</span></span>
<span><span class="co"># column-normalized kernel</span></span>
<span><span class="va">W_col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">W_raw</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">W_raw</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Interpolate both brackets</span></span>
<span><span class="va">young_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">W_col</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">src_young</span><span class="op">)</span></span>
<span><span class="va">old_hat</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">W_col</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">src_old</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"=== Young bracket ===\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; === Young bracket ===</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Census truth:     "</span>, <span class="va">pop_young</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Census truth:      60 100 50 30 20</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Column-normalized:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">young_hat</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Column-normalized: 141 70 9 28 12</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"SSE:             "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">young_hat</span> <span class="op">-</span> <span class="va">pop_young</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; SSE:              9095</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\n=== Old bracket ===\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; === Old bracket ===</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Census truth:     "</span>, <span class="va">pop_old</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Census truth:      40 200 100 170 230</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Column-normalized:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">old_hat</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Column-normalized: 113 291 44 203 90</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"SSE:             "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">old_hat</span> <span class="op">-</span> <span class="va">pop_old</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; SSE:              37428</span></span></code></pre></div>
<p>The alpha optimization reduces this SSE by finding per-tract decay
parameters that best match both demographic distributions.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Visual comparison: census truth vs column-normalized estimate</span></span>
<span><span class="va">pop_mat_toy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>young <span class="op">=</span> <span class="va">pop_young</span>, old <span class="op">=</span> <span class="va">pop_old</span><span class="op">)</span></span>
<span><span class="va">comparison_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  tract <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>  value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pop_young</span>, <span class="va">pop_old</span>, <span class="va">young_hat</span>, <span class="va">old_hat</span><span class="op">)</span>,</span>
<span>  bracket <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Young"</span>, <span class="st">"Old"</span>, <span class="st">"Young"</span>, <span class="st">"Old"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>  source <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Census truth"</span>, <span class="st">"Census truth"</span>,</span>
<span>                  <span class="st">"Column-normalized estimate"</span>,</span>
<span>                  <span class="st">"Column-normalized estimate"</span><span class="op">)</span>,</span>
<span>               each <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">comparison_df</span>,</span>
<span>       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">tract</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">value</span>, fill <span class="op">=</span> <span class="va">source</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col</a></span><span class="op">(</span>position <span class="op">=</span> <span class="st">"dodge"</span>, width <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">bracket</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Census truth"</span> <span class="op">=</span> <span class="st">"#4575b4"</span>,</span>
<span>                                <span class="st">"Column-normalized estimate"</span> <span class="op">=</span> <span class="st">"#fdae61"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Per-Bracket Column Normalization: Recovery of Age-Group Profiles"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Tract"</span>, y <span class="op">=</span> <span class="st">"Population"</span>, fill <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>        legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code></pre></div>
<p><img src="methodology_files/figure-html/per-bracket-comparison-plot-1.png" alt="" width="100%"></p>
</div>
<div class="section level5">
<h5 id="connection-to-the-optimizer">Connection to the optimizer<a class="anchor" aria-label="anchor" href="#connection-to-the-optimizer"></a>
</h5>
<p>During optimization (Section 14), the per-bracket column
normalization is performed on 3D tensors of shape
<code>[ka x n x m]</code>, where <code>ka</code> is the number of active
demographic brackets. This vectorizes all
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>K</mi><annotation encoding="application/x-tex">K</annotation></semantics></math>
separate normalization operations into a single batched computation on
GPU or CPU.</p>
<p>After optimization, the weight matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>W</mi><annotation encoding="application/x-tex">W</annotation></semantics></math>
is returned directly from <code><a href="../reference/optimize_alpha.html">optimize_alpha()</a></code> as
<code>result$W</code>. It can also be recomputed from pre-existing alpha
values using <code><a href="../reference/compute_weight_matrix.html">compute_weight_matrix()</a></code>:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># W is already in the optimization result</span></span>
<span><span class="va">W</span> <span class="op">&lt;-</span> <span class="va">optim_result</span><span class="op">$</span><span class="va">W</span></span>
<span></span>
<span><span class="co"># Or recompute from alpha</span></span>
<span><span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_weight_matrix.html">compute_weight_matrix</a></span><span class="op">(</span><span class="va">time_matrix</span>, <span class="va">alpha</span>,</span>
<span>  pop_matrix <span class="op">=</span> <span class="va">pop_matrix</span>,</span>
<span>  source_matrix <span class="op">=</span> <span class="va">source_matrix</span><span class="op">)</span></span></code></pre></div>
<p>When <code>pop_matrix</code> and <code>source_matrix</code> are
provided, the function automatically uses per-bracket mode.</p>
</div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="part-v-calibration-and-optimization">Part V: Calibration and Optimization<a class="anchor" aria-label="anchor" href="#part-v-calibration-and-optimization"></a>
</h2>
<div class="section level3">
<h3 id="the-calibration-objective">13. The Calibration Objective<a class="anchor" aria-label="anchor" href="#the-calibration-objective"></a>
</h3>
<div class="section level4">
<h4 id="the-key-insight">13.1 The key insight<a class="anchor" aria-label="anchor" href="#the-key-insight"></a>
</h4>
<p>We have all the ingredients: travel times, an IDW kernel parametrized
by
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>,
and column normalization to enforce source conservation. Now we need to
find the right
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>.</p>
<p>Here is the calibration logic: <strong>if the weights are correct,
then interpolating voter age profiles from stations should recover the
census age profiles at each tract.</strong></p>
<p>Consider a concrete example. Census data says tract X has 200 people
aged 30–39. If our weights are good, then multiplying the weight row for
tract X by the station-level voter counts for the 30–39 age bracket
should give us approximately 200. If it gives 150 or 300, the weights
are wrong — the geographic allocation is biased.</p>
<p>The optimization finds
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
values that minimize this mismatch across all tracts and all age
brackets simultaneously.</p>
</div>
<div class="section level4">
<h4 id="the-iterative-procedure">13.2 The iterative procedure<a class="anchor" aria-label="anchor" href="#the-iterative-procedure"></a>
</h4>
<p>The optimization is a loop:</p>
<p><img src="figures/optimization-loop-diagram.png" alt="" width="80%"></p>
<p>In words:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Initialize</strong>: set
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\alpha_i = 1</annotation></semantics></math>
for all tracts (moderate decay)</li>
<li>
<strong>Build the IDW kernel</strong>: compute raw weights from
travel times and current
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
</li>
<li>
<strong>Column-normalize</strong>: enforce source conservation
(column sums = 1)</li>
<li>
<strong>Interpolate demographics</strong>: multiply normalized
weights by station-level age profiles</li>
<li>
<strong>Compare with census</strong>: compute the squared error
between interpolated and census age profiles</li>
<li>
<strong>Adjust
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></strong>:
use the gradient (via automatic differentiation) to nudge
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
in the direction that reduces error</li>
<li>
<strong>Repeat</strong> until the error stops decreasing</li>
</ol>
<p>Each iteration of this loop evaluates the complete forward pass:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi><mo>→</mo><mtext mathvariant="normal">kernel</mtext><mo>→</mo><mtext mathvariant="normal">column-normalize</mtext><mo>→</mo><mtext mathvariant="normal">interpolation</mtext><mo>→</mo><mtext mathvariant="normal">error</mtext></mrow><annotation encoding="application/x-tex">\alpha \to \text{kernel} \to \text{column-normalize} \to \text{interpolation}
\to \text{error}</annotation></semantics></math>.</p>
</div>
<div class="section level4">
<h4 id="the-formal-objective">13.3 The formal objective<a class="anchor" aria-label="anchor" href="#the-formal-objective"></a>
</h4>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><munder><mo>∑</mo><mi>i</mi></munder><munder><mo>∑</mo><mi>k</mi></munder><msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mover><mi>V</mi><mo accent="true">̂</mo></mover><mrow><mi>i</mi><mi>k</mi></mrow></msub><mo>−</mo><msub><mi>P</mi><mrow><mi>i</mi><mi>k</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">f(\alpha) = \sum_i \sum_k \left( \hat{V}_{ik} - P_{ik} \right)^2</annotation></semantics></math></p>
<p>where:</p>
<ul>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>V</mi><mo accent="true">̂</mo></mover><mo>=</mo><mi>W</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>×</mo><mi>S</mi></mrow><annotation encoding="application/x-tex">\hat{V} = W(\alpha) \times S</annotation></semantics></math>
— interpolated voter demographics per tract, with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>W</mi><annotation encoding="application/x-tex">W</annotation></semantics></math>
built via per-bracket column normalization (Section 12.3)</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>P</mi><annotation encoding="application/x-tex">P</annotation></semantics></math>
— census demographics per tract</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>
= demographic bracket index
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo>=</mo><mn>7</mn></mrow><annotation encoding="application/x-tex">K = 7</annotation></semantics></math>
for age-only calibration,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo>=</mo><mn>14</mn></mrow><annotation encoding="application/x-tex">K = 14</annotation></semantics></math>
for full gender × age calibration)</li>
</ul>
<p>The weight matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">W(\alpha)</annotation></semantics></math>
is the aggregation of per-bracket column-normalized matrices
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>W</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>k</mi><mo stretchy="true" form="postfix">)</mo></mrow></msup><annotation encoding="application/x-tex">W^{(k)}</annotation></semantics></math>,
followed by a final column normalization pass.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Simplified case: all tracts share the same alpha</span></span>
<span><span class="va">tt_adj</span> <span class="op">&lt;-</span> <span class="va">tt_toy</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="va">pop_matrix_toy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">pop_toy</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">src_matrix_toy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">250</span>, <span class="fl">400</span>, <span class="fl">350</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">alpha_range</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">8</span>, by <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="va">sse_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">alpha_range</span>, <span class="kw">function</span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Compute column-normalized weights and SSE</span></span>
<span>  <span class="va">K</span> <span class="op">&lt;-</span> <span class="va">tt_adj</span> <span class="op">^</span> <span class="op">(</span><span class="op">-</span><span class="va">a</span><span class="op">)</span></span>
<span>  <span class="va">K</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">K</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">K</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">K</span><span class="op">)</span><span class="op">)</span>  <span class="co"># column-normalize</span></span>
<span>  <span class="va">v_hat</span> <span class="op">&lt;-</span> <span class="va">W</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">src_matrix_toy</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">v_hat</span> <span class="op">-</span> <span class="va">pop_matrix_toy</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="va">alpha_range</span>, sse <span class="op">=</span> <span class="va">sse_values</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">alpha</span>, y <span class="op">=</span> <span class="va">sse</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"#4575b4"</span>, linewidth <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">alpha_range</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.min</a></span><span class="op">(</span><span class="va">sse_values</span><span class="op">)</span><span class="op">]</span>,</span>
<span>             linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"#d73027"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Objective Function Landscape"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span></span>
<span>         <span class="st">"Minimum at alpha = %.1f (shared across all tracts)"</span>,</span>
<span>         <span class="va">alpha_range</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.min</a></span><span class="op">(</span><span class="va">sse_values</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,</span>
<span>       x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">alpha</span><span class="op">)</span>, y <span class="op">=</span> <span class="st">"SSE"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="methodology_files/figure-html/objective-landscape-1.png" alt="" width="100%"></p>
<p>The landscape has a clear minimum. In practice, each tract has its
own alpha, creating a high-dimensional optimization problem.</p>
</div>
</div>
<div class="section level3">
<h3 id="optimization-per-bracket-gradient-descent-with-column-normalization">14. Optimization: Per-Bracket Gradient Descent with Column
Normalization<a class="anchor" aria-label="anchor" href="#optimization-per-bracket-gradient-descent-with-column-normalization"></a>
</h3>
<div class="section level4">
<h4 id="why-automatic-differentiation">14.1 Why automatic differentiation?<a class="anchor" aria-label="anchor" href="#why-automatic-differentiation"></a>
</h4>
<p>The objective function involves column normalization of the IDW
kernel, followed by matrix multiplication and a squared-error loss.
Writing the analytical gradient by hand is straightforward for simple
column normalization, but becomes tedious when combined with the
per-bracket structure and exponential reparameterization.</p>
<p>Torch’s <strong>automatic differentiation</strong> handles this: we
define the forward pass (kernel -&gt; column-normalize -&gt;
interpolation -&gt; loss), and torch computes the gradient of the loss
with respect to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
automatically by recording every operation and applying the chain rule
backward.</p>
</div>
<div class="section level4">
<h4 id="log-domain-computation-for-numerical-stability">14.2 Log-domain computation for numerical stability<a class="anchor" aria-label="anchor" href="#log-domain-computation-for-numerical-stability"></a>
</h4>
<p>When
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
is large and travel times vary widely, some weights become
astronomically small:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Demonstrate the underflow problem</span></span>
<span><span class="va">tt_demo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">20</span>, <span class="fl">60</span>, <span class="fl">120</span>, <span class="fl">200</span><span class="op">)</span>  <span class="co"># travel times (minutes)</span></span>
<span><span class="va">alpha_high</span> <span class="op">&lt;-</span> <span class="fl">8</span></span>
<span></span>
<span><span class="va">raw</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">tt_demo</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="va">alpha_high</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Raw weights at alpha = 8:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Raw weights at alpha = 8:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/formatc.html" class="external-link">formatC</a></span><span class="op">(</span><span class="va">raw</span>, format <span class="op">=</span> <span class="st">"e"</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; 5.95e-07 2.64e-11 5.22e-15 2.18e-17 3.75e-19</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nIn float32, values below ~1.2e-38 become exactly 0\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; In float32, values below ~1.2e-38 become exactly 0</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Zero weights cause division by zero in column normalization\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Zero weights cause division by zero in column normalization</span></span></code></pre></div>
<p>In 32-bit floating point (standard for GPU computation), numbers
smaller than about
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1.2</mn><mo>×</mo><msup><mn>10</mn><mrow><mi>−</mi><mn>38</mn></mrow></msup></mrow><annotation encoding="application/x-tex">1.2 \times 10^{-38}</annotation></semantics></math>
underflow to zero. When a weight becomes exactly zero, the column
normalization produces
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mi>/</mi><mn>0</mn><mo>=</mo><mtext mathvariant="normal">NaN</mtext></mrow><annotation encoding="application/x-tex">0/0 = \text{NaN}</annotation></semantics></math>,
and the optimization collapses.</p>
<p><strong>The log-domain solution</strong>: the IDW kernel is computed
in log space as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><msub><mi>K</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mi>−</mi><msub><mi>α</mi><mi>i</mi></msub><mo>⋅</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>t</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>+</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\log K_{ij} = -\alpha_i \cdot \log(t_{ij} + 1)</annotation></semantics></math>,
and the column normalization uses the <strong>logsumexp</strong> trick
for numerical stability. The logsumexp function
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mo>∑</mo><mi>j</mi></msub><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>x</mi><mi>j</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\log(\sum_j \exp(x_j))</annotation></semantics></math>
is a numerically stable primitive available in torch.</p>
</div>
<div class="section level4">
<h4 id="the-column-normalization-algorithm">14.3 The column normalization algorithm<a class="anchor" aria-label="anchor" href="#the-column-normalization-algorithm"></a>
</h4>
<p>The optimizer performs per-bracket column normalization on 3D
tensors. The tensor shapes involved:</p>
<table class="table">
<thead><tr class="header">
<th>Symbol</th>
<th>Shape</th>
<th>Meaning</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>log_t</code></td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">[</mo><mi>n</mi><mo>×</mo><mi>m</mi><mo stretchy="true" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">[n \times m]</annotation></semantics></math></td>
<td>Log travel times (precomputed once)</td>
</tr>
<tr class="even">
<td><code>alpha</code></td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">[</mo><mi>n</mi><mo stretchy="true" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">[n]</annotation></semantics></math></td>
<td>Decay parameters (what we’re optimizing)</td>
</tr>
<tr class="odd">
<td><code>P</code></td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">[</mo><mi>n</mi><mo>×</mo><msub><mi>k</mi><mi>a</mi></msub><mo stretchy="true" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">[n \times k_a]</annotation></semantics></math></td>
<td>Census population per tract and bracket</td>
</tr>
<tr class="even">
<td><code>V</code></td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">[</mo><mi>m</mi><mo>×</mo><msub><mi>k</mi><mi>a</mi></msub><mo stretchy="true" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">[m \times k_a]</annotation></semantics></math></td>
<td>Voter counts per station and bracket</td>
</tr>
<tr class="odd">
<td><code>log_K</code></td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">[</mo><mi>n</mi><mo>×</mo><mi>m</mi><mo stretchy="true" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">[n \times m]</annotation></semantics></math></td>
<td>Log-kernel (broadcast to 3D)</td>
</tr>
<tr class="even">
<td><code>W_all</code></td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">[</mo><msub><mi>k</mi><mi>a</mi></msub><mo>×</mo><mi>n</mi><mo>×</mo><mi>m</mi><mo stretchy="true" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">[k_a \times n \times m]</annotation></semantics></math></td>
<td>Per-bracket weight tensors</td>
</tr>
</tbody>
</table>
<p>The first dimension
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>k</mi><mi>a</mi></msub><annotation encoding="application/x-tex">k_a</annotation></semantics></math>)
indexes demographic brackets. All
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>k</mi><mi>a</mi></msub><annotation encoding="application/x-tex">k_a</annotation></semantics></math>
brackets share the same kernel — column normalization is applied
independently to each bracket slice.</p>
<pre><code>Input: log_t[n,m], alpha[n], P[n,ka], V[m,ka]

# Log-kernel (same for all brackets)
log_K[i,j] = -alpha[i] * log_t[i, j]                  # [n x m]

# Column normalization in log domain (per bracket)
log_colsum[j] = logsumexp_i(log_K[i,j])               # [m]
W[i,j] = exp(log_K[i,j] - log_colsum[j])              # [n x m]

# Per-bracket: broadcast W to [ka x n x m], then interpolate
V_hat = W @ V                                          # [n x ka]
loss = sum((V_hat - P)^2)</code></pre>
<p>Every operation — log, exp, logsumexp, matrix multiply, subtraction,
squaring — has a defined backward pass in torch. The gradient
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>∇</mi><mi>α</mi></msub><mi>f</mi></mrow><annotation encoding="application/x-tex">\nabla_\alpha f</annotation></semantics></math>
flows backward through the column normalization automatically.</p>
</div>
<div class="section level4">
<h4 id="adam-optimization-with-per-bracket-weights">14.4 ADAM optimization with per-bracket weights<a class="anchor" aria-label="anchor" href="#adam-optimization-with-per-bracket-weights"></a>
</h4>
<p>We use <strong>ADAM</strong> (Adaptive Moment Estimation) as the
underlying optimizer, with <strong>per-bracket column
normalization</strong>. At each gradient step:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Build the IDW kernel</strong> from current alpha values</li>
<li>
<strong>Per-bracket column normalization</strong>: each demographic
column uses the same column-normalized kernel</li>
<li>
<strong>Compute loss</strong>: SSE between interpolated and observed
values</li>
<li>
<strong>Backward + Adam step</strong> on the unconstrained
<code>theta</code> parameters</li>
</ol>
<p>At the end of each epoch, the <strong>true objective</strong> is
evaluated on the full dataset (no gradient) and used for convergence
monitoring and logging.</p>
<p><strong>Exponential reparameterization</strong>: alpha is not
optimized directly. Instead we optimize <code>theta</code>
(unconstrained) where <code>alpha = exp(theta)</code>, initialized as
<code>theta = log(alpha_init)</code>. This ensures:</p>
<ul>
<li>Alpha is always strictly positive — no clamping or projection
needed</li>
<li>Gradient <code>d(alpha)/d(theta) = alpha</code> — no saturation at
any boundary</li>
<li>Corner solutions due to hard boundary constraints cannot occur</li>
</ul>
<p>The learning rate is reduced by half when the epoch loss plateaus
(ReduceLROnPlateau with patience = 2 x early-stop patience).</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">optim_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optimize_alpha.html">optimize_alpha</a></span><span class="op">(</span></span>
<span>  time_matrix   <span class="op">=</span> <span class="va">time_matrix</span>,</span>
<span>  pop_matrix    <span class="op">=</span> <span class="va">pop_matrix</span>,</span>
<span>  source_matrix <span class="op">=</span> <span class="va">source_matrix</span>,</span>
<span>  row_targets   <span class="op">=</span> <span class="va">row_targets</span>,</span>
<span>  optim <span class="op">=</span> <span class="fu"><a href="../reference/optim_control.html">optim_control</a></span><span class="op">(</span></span>
<span>    max_epochs <span class="op">=</span> <span class="fl">200</span>,      <span class="co"># maximum epochs</span></span>
<span>    lr_init    <span class="op">=</span> <span class="fl">0.05</span>,     <span class="co"># initial learning rate (auto-reduced on plateau)</span></span>
<span>    use_gpu    <span class="op">=</span> <span class="cn">FALSE</span>     <span class="co"># CPU for small problems</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/optim-convergence.png" alt="" width="90%"></p>
<p>The epoch loss curve shows the <strong>true objective</strong>
evaluated on all tracts at the end of each epoch. The package tracks the
best epoch loss and returns the corresponding alpha values.</p>
<p><strong>Key tuning parameters</strong>:</p>
<p>Tuning parameters are grouped in <code><a href="../reference/optim_control.html">optim_control()</a></code>:</p>
<table class="table">
<colgroup>
<col width="33%">
<col width="33%">
<col width="33%">
</colgroup>
<thead><tr class="header">
<th>Parameter</th>
<th>Default</th>
<th>Effect</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>max_epochs</code></td>
<td>2000</td>
<td>Maximum epochs.</td>
</tr>
<tr class="even">
<td><code>lr_init</code></td>
<td>0.05</td>
<td>Initial learning rate. Auto-reduced when loss plateaus.</td>
</tr>
<tr class="odd">
<td><code>dtype</code></td>
<td><code>"float32"</code></td>
<td>
<code>"float64"</code> for more precision (2x memory).</td>
</tr>
<tr class="even">
<td><code>alpha_min</code></td>
<td>1</td>
<td>Lower bound for alpha (via softplus reparameterization).</td>
</tr>
<tr class="odd">
<td><code>use_gpu</code></td>
<td><code>FALSE</code></td>
<td>Enable GPU acceleration (CUDA/MPS).</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="section level2">
<h2 id="part-vi-results-and-validation">Part VI: Results and Validation<a class="anchor" aria-label="anchor" href="#part-vi-results-and-validation"></a>
</h2>
<div class="section level3">
<h3 id="the-effect-of-alpha-spatial-interpretation">15. The Effect of Alpha: Spatial Interpretation<a class="anchor" aria-label="anchor" href="#the-effect-of-alpha-spatial-interpretation"></a>
</h3>
<p><img src="figures/alpha-histogram.png" alt="" width="80%"></p>
<p>Most alphas cluster in a moderate range, with tails extending toward
0 (uniform allocation) and large values (nearest-station-only).</p>
<p><img src="figures/alpha-map.png" alt="" width="100%"></p>
<ul>
<li>
<strong>Low alpha</strong> (blue, urban core): weight is spread
across many nearby stations. Multiple stations overlap, and the
optimizer distributes influence broadly.</li>
<li>
<strong>High alpha</strong> (red, periphery): weight is concentrated
on the nearest station. Isolated tracts with one dominant station.</li>
</ul>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># How alpha changes the weight distribution for a fixed tract</span></span>
<span><span class="va">tt_one_tract</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">8</span>, <span class="fl">15</span>, <span class="fl">25</span>, <span class="fl">40</span><span class="op">)</span></span>
<span><span class="va">alphas_demo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">wt_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">alphas_demo</span>, <span class="kw">function</span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">w</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">tt_one_tract</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="va">a</span><span class="op">)</span></span>
<span>  <span class="va">w</span> <span class="op">&lt;-</span> <span class="va">w</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">w</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>station <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, weight <span class="op">=</span> <span class="va">w</span>,</span>
<span>             alpha <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"alpha = "</span>, <span class="va">a</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">wt_df</span><span class="op">$</span><span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">wt_df</span><span class="op">$</span><span class="va">alpha</span>,</span>
<span>                        levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"alpha = "</span>, <span class="va">alphas_demo</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">wt_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">station</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">weight</span>, fill <span class="op">=</span> <span class="va">alpha</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col</a></span><span class="op">(</span>position <span class="op">=</span> <span class="st">"dodge"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Weight Distribution as Alpha Increases"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Fixed tract, 5 stations at 3, 8, 15, 25, 40 min"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Station (sorted by distance)"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Normalized weight"</span>, fill <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="methodology_files/figure-html/alpha-effect-1.png" alt="" width="100%"></p>
<p>At
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\alpha = 1</annotation></semantics></math>,
weights are nearly uniform. At
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi><mo>=</mo><mn>10</mn></mrow><annotation encoding="application/x-tex">\alpha = 10</annotation></semantics></math>,
the nearest station dominates with ~85% of the weight.</p>
<p><strong>Interpretation guide</strong>:</p>
<ul>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi><mo>&lt;</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\alpha &lt; 1</annotation></semantics></math>:
draws information almost equally from all stations. Unusual — check for
data issues.</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi><mo>∈</mo><mrow><mo stretchy="true" form="prefix">[</mo><mn>1</mn><mo>,</mo><mn>3</mn><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">\alpha \in [1, 3]</annotation></semantics></math>:
several nearby stations contribute. Typical for dense urban areas.</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi><mo>∈</mo><mrow><mo stretchy="true" form="prefix">[</mo><mn>3</mn><mo>,</mo><mn>6</mn><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">\alpha \in [3, 6]</annotation></semantics></math>:
a few stations dominate. Typical for suburban areas.</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi><mo>&gt;</mo><mn>6</mn></mrow><annotation encoding="application/x-tex">\alpha &gt; 6</annotation></semantics></math>:
one station dominates almost entirely. Typical for isolated tracts.</li>
</ul>
</div>
<div class="section level3">
<h3 id="the-interpolation-from-weights-to-tract-level-estimates">16. The Interpolation: From Weights to Tract-Level Estimates<a class="anchor" aria-label="anchor" href="#the-interpolation-from-weights-to-tract-level-estimates"></a>
</h3>
<p>The weight matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>W</mi><annotation encoding="application/x-tex">W</annotation></semantics></math>
encodes the geographic relationship between tracts and stations.
Multiplying by any station-level variable produces tract-level
estimates:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>X</mi><mo accent="true">̂</mo></mover><mo>=</mo><mi>W</mi><mo>×</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">\hat{X} = W \times V</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>W</mi><annotation encoding="application/x-tex">W</annotation></semantics></math>
is [N × M],
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>V</mi><annotation encoding="application/x-tex">V</annotation></semantics></math>
is [M × 1], and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>X</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat{X}</annotation></semantics></math>
is [N × 1]. For multiple variables:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>X</mi><mo accent="true">̂</mo></mover><mo>=</mo><mi>W</mi><mo>×</mo><msub><mi>V</mi><mtext mathvariant="normal">matrix</mtext></msub></mrow><annotation encoding="application/x-tex">\hat{X} = W \times V_{\text{matrix}}</annotation></semantics></math>
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>V</mi><mtext mathvariant="normal">matrix</mtext></msub><annotation encoding="application/x-tex">V_{\text{matrix}}</annotation></semantics></math>
is [M × P].</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># W is returned directly from optimization</span></span>
<span><span class="va">W</span> <span class="op">&lt;-</span> <span class="va">optim_result</span><span class="op">$</span><span class="va">W</span></span>
<span></span>
<span><span class="va">electoral_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span></span>
<span>  <span class="va">sources</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CAND_13"</span>, <span class="st">"CAND_22"</span>, <span class="st">"QT_COMPARECIMENTO"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span><span class="va">interpolated</span> <span class="op">&lt;-</span> <span class="va">W</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">electoral_data</span></span>
<span></span>
<span><span class="va">pct_lula</span> <span class="op">&lt;-</span> <span class="va">interpolated</span><span class="op">[</span>, <span class="st">"CAND_13"</span><span class="op">]</span> <span class="op">/</span></span>
<span>  <span class="va">interpolated</span><span class="op">[</span>, <span class="st">"QT_COMPARECIMENTO"</span><span class="op">]</span> <span class="op">*</span> <span class="fl">100</span></span></code></pre></div>
<p><img src="figures/interp-lula.png" alt="" width="100%"></p>
<p><img src="figures/interp-bolsonaro.png" alt="" width="100%"></p>
<p>Geographic polarization becomes visible at the tract level — a
spatial pattern that was previously impossible to observe with
station-level data alone.</p>
<p><strong>Calibration validation</strong>: interpolated demographics
should match census demographics (the optimization objective).</p>
<p><img src="figures/interp-scatter-calib.png" alt="" width="80%"></p>
<p>Points cluster tightly around the 45-degree line, confirming that the
optimization found good weights.</p>
<p><strong>The reuse principle</strong>: the weight matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>W</mi><annotation encoding="application/x-tex">W</annotation></semantics></math>
is a property of the geography and the calibration. Once computed, it
can interpolate <strong>any</strong> variable measured at polling
stations — candidates, parties, turnout, gender composition, education
level — without re-optimizing alpha.</p>
</div>
<div class="section level3">
<h3 id="validation-how-well-did-we-recover-the-age-structure">17. Validation: How Well Did We Recover the Age Structure?<a class="anchor" aria-label="anchor" href="#validation-how-well-did-we-recover-the-age-structure"></a>
</h3>
<div class="section level4">
<h4 id="conservation-properties">17.1 Conservation properties<a class="anchor" aria-label="anchor" href="#conservation-properties"></a>
</h4>
<p><strong>Column conservation</strong> (source conservation):</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>W</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mn>1</mn><mspace width="1.0em"></mspace><mo>∀</mo><mi>j</mi></mrow><annotation encoding="application/x-tex">\sum_i W_{ij} = 1 \quad \forall j</annotation></semantics></math></p>
<p>Each station distributes exactly 100% of its data. Municipal totals
are preserved exactly.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">votes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">500</span>, <span class="fl">800</span>, <span class="fl">700</span><span class="op">)</span></span>
<span><span class="va">interpolated_votes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">W_col</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">votes</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Source total:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">votes</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Source total: 2000</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Interpolated total:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">interpolated_votes</span><span class="op">)</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Interpolated total: 2000</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Per-tract:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">interpolated_votes</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Per-tract: 506 722 106 461 204</span></span></code></pre></div>
<p><strong>Calibration residuals</strong>:</p>
<p><img src="figures/residuals-boxplot.png" alt="" width="90%"></p>
<p>Residuals should be centered near zero with small magnitude. Outliers
may indicate boundary effects (voters crossing municipality borders) or
data quality issues.</p>
</div>
<div class="section level4">
<h4 id="age-pyramid-recovery-rocinha-and-copacabana-revisited">17.2 Age pyramid recovery: Rocinha and Copacabana revisited<a class="anchor" aria-label="anchor" href="#age-pyramid-recovery-rocinha-and-copacabana-revisited"></a>
</h4>
<p>In Section 1, we showed that Rocinha and Copacabana have strikingly
different age structures. Does the interpolation recover these
patterns?</p>
<p><img src="figures/age-recovery-rocinha-copacabana.png" alt="" width="100%"></p>
<p>The blue bars show the census truth (population by age bracket) and
the yellow bars show the IDW-interpolated voter profiles. The
interpolation closely recovers the distinctive age patterns of both
neighborhoods: Rocinha’s young skew and Copacabana’s aging profile.</p>
<p>This is a demanding test. The method does not know anything about
Rocinha or Copacabana as neighborhoods — it only sees census tracts and
polling stations. Yet the calibration against age brackets produces
weights that correctly recover the neighborhood-level demographic
signatures.</p>
</div>
<div class="section level4">
<h4 id="comparison-with-voronoi-assignment">17.3 Comparison with Voronoi assignment<a class="anchor" aria-label="anchor" href="#comparison-with-voronoi-assignment"></a>
</h4>
<p>The simplest alternative to our method is <strong>Voronoi
assignment</strong>: assign each tract to its nearest polling station
and use that station’s data directly. This is equivalent to constructing
Voronoi (Thiessen) polygons around each station and assigning each tract
100% of the weight from one station.</p>
<p>We compare both methods across <strong>four Brazilian state
capitals</strong> with diverse urban morphologies: Palmas (TO), Cuiabá
(MT), Manaus (AM), and Natal (RN).</p>
<p><img src="figures/voronoi-palmas-map.png" alt="" width="100%"></p>
<p>In the Voronoi approach, each tract inherits the complete demographic
and electoral profile of a single station. This ignores the many-to-many
structure: a tract near the boundary between two Voronoi cells gets none
of the influence from the station just across the boundary.</p>
<p>How well do the two methods recover the census age structure? The
following figure compares predicted versus observed demographic profiles
across all four cities:</p>
<p>IDW points cluster tightly around the 45-degree line in every city.
Voronoi points show much more scatter — many tracts have large
prediction errors because they were assigned to a station with a very
different demographic composition.</p>
<p>The residual boxplots confirm the pattern across all four cities: IDW
residuals are tightly centered around zero, while Voronoi residuals have
much larger spread.</p>
<p>The aggregate SSE ratio quantifies the advantage:</p>
<p><img src="figures/voronoi-sse-ratio-cities.png" alt="" width="90%"></p>
<p>In every city, the IDW method achieves dramatically lower squared
error than Voronoi assignment — by a factor of 275x (Cuiaba) to 1,624x
(Manaus), with Palmas at 601x and Natal at 639x. The advantage is
consistent across cities of different sizes and urban layouts,
confirming that smooth, calibrated weighting is fundamentally superior
to hard nearest-station assignment.</p>
</div>
<div class="section level4">
<h4 id="ecological-correlation-lula-vote-share-and-household-income">17.4 Ecological correlation: Lula vote share and household
income<a class="anchor" aria-label="anchor" href="#ecological-correlation-lula-vote-share-and-household-income"></a>
</h4>
<p>As a final validation exercise, we examine whether the interpolated
voting patterns exhibit expected ecological correlations. If the spatial
weights are correct, interpolated vote shares should correlate with
tract-level socioeconomic indicators from independent data sources.</p>
<p>We correlate the interpolated percentage of votes for Lula (PT) in
each census tract with the average monthly income of household heads,
obtained from the 2022 Census (via
<code>censobr::read_tracts(2022, "ResponsavelRenda")</code>). We show
this correlation for four cities with very different socioeconomic
profiles: São Paulo (SP), Salvador (BA), Porto Alegre (RS), and Cuiabá
(MT).</p>
<p><img src="figures/lula-income-correlation.png" alt="" width="100%"></p>
<p>The negative correlation is consistent across all four cities and
with well-established patterns in Brazilian electoral geography:
lower-income areas tend to vote more heavily for PT candidates, while
higher-income areas lean toward other parties. The fact that our
interpolated tract-level estimates reproduce this pattern — using vote
data that was originally measured at polling stations, not at tracts —
provides external validation that the spatial weights are geographically
meaningful.</p>
<p>The income data is log-transformed
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo>+</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\log(x+1)</annotation></semantics></math>)
to reduce the influence of extreme values and improve linearity.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="part-vii-practical">Part VII: Practical<a class="anchor" aria-label="anchor" href="#part-vii-practical"></a>
</h2>
<div class="section level3">
<h3 id="performance-and-tuning">18. Performance and Tuning<a class="anchor" aria-label="anchor" href="#performance-and-tuning"></a>
</h3>
<p>All timings below assume default optimization parameters:
<code>max_epochs = 200</code>, <code>dtype = "float32"</code>.</p>
<table class="table">
<thead><tr class="header">
<th>Problem size (tracts)</th>
<th>Recommendation</th>
<th>Typical optimization time</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>&lt; 200</td>
<td>CPU</td>
<td>10–30 seconds</td>
</tr>
<tr class="even">
<td>200–1,000</td>
<td>CPU or GPU</td>
<td>30s – 2 min</td>
</tr>
<tr class="odd">
<td>1,000–5,000</td>
<td>GPU recommended</td>
<td>15s – 2 min</td>
</tr>
<tr class="even">
<td>&gt; 5,000</td>
<td>GPU strongly recommended</td>
<td>2–10 min</td>
</tr>
</tbody>
</table>
<p><strong>Practical runtimes</strong> (optimization step only, from
actual runs):</p>
<ul>
<li>Igrejinha (85 tracts, 17 stations): ~24s CPU</li>
<li>Varginha (279 tracts, 37 stations): ~52s CPU</li>
<li>Palmas (660 tracts, 71 stations): ~135s CPU</li>
<li>Niterói (1,169 tracts, 135 stations): ~17s GPU</li>
<li>Belo Horizonte (5,113 tracts, 407 stations): ~105s GPU</li>
<li>Rio de Janeiro (13,370 tracts, 1,392 stations): ~10 min GPU</li>
</ul>
<p>Note that total wall-clock time for
<code><a href="../reference/interpolate_election_br.html">interpolate_election_br()</a></code> also includes data downloads,
travel time computation (via r5r), and weight matrix construction, which
can dominate for larger cities.</p>
<p><strong>Memory estimation.</strong> GPU memory during optimization
has two main components:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Full kernel matrix</strong> (always in memory):
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>×</mo><mi>m</mi><mo>×</mo><mtext mathvariant="normal">bytes</mtext></mrow><annotation encoding="application/x-tex">n \times m \times
\text{bytes}</annotation></semantics></math> — e.g., 5,100 x 407 x 4 = 8
MB for Belo Horizonte in float32.</li>
<li>
<strong>Per-bracket weight tensors</strong>:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>k</mi><mi>a</mi></msub><mo>×</mo><mi>n</mi><mo>×</mo><mi>m</mi><mo>×</mo><mtext mathvariant="normal">bytes</mtext></mrow><annotation encoding="application/x-tex">k_a \times n \times m \times
\text{bytes}</annotation></semantics></math> — torch must store
intermediate tensors for backpropagation through the column
normalization.</li>
</ol>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>k</mi><mi>a</mi></msub><mo>=</mo><mn>14</mn></mrow><annotation encoding="application/x-tex">k_a = 14</annotation></semantics></math>
(gender × 7 age brackets) and <code>bytes</code> is 4 (float32) or 8
(float64).</p>
<table class="table">
<thead><tr class="header">
<th>Municipality</th>
<th>Tracts</th>
<th>Stations</th>
<th><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>k</mi><mi>a</mi></msub><annotation encoding="application/x-tex">k_a</annotation></semantics></math></th>
<th>Estimated GPU memory</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Varginha</td>
<td>279</td>
<td>37</td>
<td>14</td>
<td>~28 MB</td>
</tr>
<tr class="even">
<td>Niteroi</td>
<td>1,169</td>
<td>135</td>
<td>14</td>
<td>~242 MB</td>
</tr>
<tr class="odd">
<td>Belo Horizonte</td>
<td>5,113</td>
<td>407</td>
<td>14</td>
<td>~729 MB</td>
</tr>
<tr class="even">
<td>Rio de Janeiro</td>
<td>13,370</td>
<td>1,392</td>
<td>14</td>
<td>~2.5 GB</td>
</tr>
</tbody>
</table>
<p>These are actual values reported by the optimizer during
precomputation. For very large cities on GPU, consider using
<code>dtype = "float32"</code> (the default) rather than
<code>"float64"</code> to halve memory usage.</p>
<p><strong>RStudio</strong>: torch inside RStudio IDE requires
subprocess execution via <code>callr</code> (automatic and transparent
to the user). Standalone R scripts run directly.</p>
</div>
<div class="section level3">
<h3 id="setup-torch-java-and-r5r">19. Setup: Torch, Java, and r5r<a class="anchor" aria-label="anchor" href="#setup-torch-java-and-r5r"></a>
</h3>
<p><strong>Torch</strong> (required for optimization):</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/setup_torch.html">setup_torch</a></span><span class="op">(</span><span class="op">)</span>    <span class="co"># installs torch + libtorch/lantern binaries</span></span>
<span><span class="fu"><a href="../reference/use_gpu.html">use_gpu</a></span><span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span>    <span class="co"># enable GPU globally</span></span></code></pre></div>
<p>GPU support: Windows (CUDA), macOS (MPS for Apple Silicon), Linux
(CUDA). CPU always works as fallback.</p>
<p><strong>Java + r5r</strong> (required for travel time
computation):</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/setup_java.html">setup_java</a></span><span class="op">(</span><span class="op">)</span>     <span class="co"># downloads and installs Java 21</span></span></code></pre></div>
<p>Memory: <code>options(java.parameters = "-Xmx8g")</code> before
loading r5r for large municipalities.</p>
<p><strong>Cache management</strong>:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/interpElections_cache.html">interpElections_cache</a></span><span class="op">(</span><span class="op">)</span>                             <span class="co"># list cached files</span></span>
<span><span class="fu"><a href="../reference/interpElections_cache.html">interpElections_cache</a></span><span class="op">(</span><span class="st">"dir"</span><span class="op">)</span>                        <span class="co"># cache directory path</span></span>
<span><span class="fu"><a href="../reference/interpElections_cache.html">interpElections_cache</a></span><span class="op">(</span><span class="st">"clean"</span>, category <span class="op">=</span> <span class="st">"votes"</span><span class="op">)</span>  <span class="co"># clear by category</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="mathematical-appendix">20. Mathematical Appendix<a class="anchor" aria-label="anchor" href="#mathematical-appendix"></a>
</h3>
<div class="section level4">
<h4 id="notation">Notation<a class="anchor" aria-label="anchor" href="#notation"></a>
</h4>
<ul>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>N</mi><annotation encoding="application/x-tex">N</annotation></semantics></math>
= number of census tracts,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>M</mi><annotation encoding="application/x-tex">M</annotation></semantics></math>
= number of polling stations</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>K</mi><annotation encoding="application/x-tex">K</annotation></semantics></math>
= number of calibration brackets (7 for age-only, 14 for full)</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>∈</mo><msup><mi>ℝ</mi><mrow><mi>N</mi><mo>×</mo><mi>M</mi></mrow></msup></mrow><annotation encoding="application/x-tex">t \in \mathbb{R}^{N \times M}</annotation></semantics></math>:
travel time matrix (minutes)</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi><mo>∈</mo><msup><mi>ℝ</mi><mi>N</mi></msup></mrow><annotation encoding="application/x-tex">\alpha \in \mathbb{R}^N</annotation></semantics></math>:
per-tract decay parameters</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo>∈</mo><msup><mi>ℝ</mi><mrow><mi>N</mi><mo>×</mo><mi>K</mi></mrow></msup></mrow><annotation encoding="application/x-tex">P \in \mathbb{R}^{N \times K}</annotation></semantics></math>:
census population by age bracket</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mo>∈</mo><msup><mi>ℝ</mi><mrow><mi>M</mi><mo>×</mo><mi>K</mi></mrow></msup></mrow><annotation encoding="application/x-tex">S \in \mathbb{R}^{M \times K}</annotation></semantics></math>:
voter counts by age bracket at stations</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mo>∈</mo><msup><mi>ℝ</mi><mi>M</mi></msup></mrow><annotation encoding="application/x-tex">c \in \mathbb{R}^M</annotation></semantics></math>:
column targets
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mi>j</mi></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">c_j = 1</annotation></semantics></math>,
enforced by column normalization)</li>
</ul>
</div>
<div class="section level4">
<h4 id="idw-kernel">IDW kernel<a class="anchor" aria-label="anchor" href="#idw-kernel"></a>
</h4>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>t</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>+</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><msub><mi>α</mi><mi>i</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">K_{ij} = (t_{ij} + 1)^{-\alpha_i}</annotation></semantics></math></p>
</div>
<div class="section level4">
<h4 id="log-domain-kernel">Log-domain kernel<a class="anchor" aria-label="anchor" href="#log-domain-kernel"></a>
</h4>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><msub><mi>K</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mi>−</mi><msub><mi>α</mi><mi>i</mi></msub><mo>⋅</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>t</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>+</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\log K_{ij} = -\alpha_i \cdot \log(t_{ij} + 1)</annotation></semantics></math></p>
</div>
<div class="section level4">
<h4 id="column-normalization">Column normalization<a class="anchor" aria-label="anchor" href="#column-normalization"></a>
</h4>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mfrac><msub><mi>K</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mrow><munder><mo>∑</mo><mrow><mi>i</mi><mi>′</mi></mrow></munder><msub><mi>K</mi><mrow><mi>i</mi><mi>′</mi><mi>j</mi></mrow></msub></mrow></mfrac></mrow><annotation encoding="application/x-tex">W_{ij} = \frac{K_{ij}}{\sum_{i'} K_{i'j}}</annotation></semantics></math></p>
<p>In log domain (for numerical stability):</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mo>exp</mo><mspace width="-0.167em"></mspace><mrow><mo stretchy="true" form="prefix">(</mo><mo>log</mo><msub><mi>K</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>−</mo><msub><mtext mathvariant="normal">logsumexp</mtext><mi>i</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mo>log</mo><msub><mi>K</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">W_{ij} = \exp\!\left(\log K_{ij} - \text{logsumexp}_i(\log K_{ij})\right)</annotation></semantics></math></p>
</div>
<div class="section level4">
<h4 id="per-bracket-column-normalization-1">Per-bracket column normalization<a class="anchor" aria-label="anchor" href="#per-bracket-column-normalization-1"></a>
</h4>
<p>For each demographic bracket
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>=</mo><mn>1</mn><mo>,</mo><mi>…</mi><mo>,</mo><mi>K</mi></mrow><annotation encoding="application/x-tex">k = 1, \ldots, K</annotation></semantics></math>:</p>
<ol style="list-style-type: decimal">
<li>Compute kernel:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>t</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>+</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><msub><mi>α</mi><mi>i</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">K_{ij} = (t_{ij} + 1)^{-\alpha_i}</annotation></semantics></math>
</li>
<li>Column-normalize:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>W</mi><mrow><mi>i</mi><mi>j</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>k</mi><mo stretchy="true" form="postfix">)</mo></mrow></msubsup><mo>=</mo><msub><mi>K</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mi>/</mi><msub><mo>∑</mo><mrow><mi>i</mi><mi>′</mi></mrow></msub><msub><mi>K</mi><mrow><mi>i</mi><mi>′</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">W^{(k)}_{ij} = K_{ij} / \sum_{i'} K_{i'j}</annotation></semantics></math>
</li>
</ol>
<p>Aggregate and column-normalize:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mtext mathvariant="normal">total</mtext></msub><mo>=</mo><munderover><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>K</mi></munderover><msup><mi>W</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>k</mi><mo stretchy="true" form="postfix">)</mo></mrow></msup></mrow><annotation encoding="application/x-tex">W_{\text{total}} = \sum_{k=1}^{K} W^{(k)}</annotation></semantics></math><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><msub><mi>W</mi><mrow><mtext mathvariant="normal">total</mtext><mo>,</mo><mi>i</mi><mi>j</mi></mrow></msub><mi minsize="2.4" maxsize="2.4">/</mi><munder><mo>∑</mo><mrow><mi>i</mi><mi>′</mi></mrow></munder><msub><mi>W</mi><mrow><mtext mathvariant="normal">total</mtext><mo>,</mo><mi>i</mi><mi>′</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">W_{ij} = W_{\text{total},ij} \bigg/ \sum_{i'} W_{\text{total},i'j}</annotation></semantics></math></p>
</div>
<div class="section level4">
<h4 id="objective-function-full-data">Objective function (full data)<a class="anchor" aria-label="anchor" href="#objective-function-full-data"></a>
</h4>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mo stretchy="false" form="postfix">∥</mo><mi>W</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>⋅</mo><mi>S</mi><mo>−</mo><mi>P</mi><msubsup><mo stretchy="false" form="postfix">∥</mo><mi>F</mi><mn>2</mn></msubsup><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><munderover><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>K</mi></munderover><msup><mrow><mo stretchy="true" form="prefix">(</mo><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><msub><mi>W</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><msub><mi>S</mi><mrow><mi>j</mi><mi>k</mi></mrow></msub><mo>−</mo><msub><mi>P</mi><mrow><mi>i</mi><mi>k</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">f(\alpha) = \| W(\alpha) \cdot S - P \|_F^2 = \sum_{i=1}^N \sum_{k=1}^K \left( \sum_{j=1}^M W_{ij} S_{jk} - P_{ik} \right)^2</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>∈</mo><msup><mi>ℝ</mi><mrow><mi>N</mi><mo>×</mo><mi>M</mi></mrow></msup></mrow><annotation encoding="application/x-tex">W(\alpha) \in \mathbb{R}^{N \times M}</annotation></semantics></math>
is the per-bracket column-normalized weight matrix.</p>
</div>
<div class="section level4">
<h4 id="gradient">Gradient<a class="anchor" aria-label="anchor" href="#gradient"></a>
</h4>
<p>Computed by torch autograd through the column normalization. Each
operation (log, exp, logsumexp, matrix multiply, subtraction, squaring)
has a defined backward pass in torch:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>∇</mi><mi>α</mi></msub><mi>f</mi><mo>=</mo><mfrac><mi>∂</mi><mrow><mi>∂</mi><mi>α</mi></mrow></mfrac><mo stretchy="false" form="postfix">∥</mo><mtext mathvariant="normal">colnorm</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mtext mathvariant="normal">kernel</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo>⋅</mo><mi>S</mi><mo>−</mo><mi>P</mi><msubsup><mo stretchy="false" form="postfix">∥</mo><mi>F</mi><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">\nabla_\alpha f = \frac{\partial}{\partial \alpha} \| \text{colnorm}(\text{kernel}(\alpha)) \cdot S - P \|_F^2</annotation></semantics></math></p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Rogerio Barbosa, Lucas Gelape.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
