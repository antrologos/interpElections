<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Understanding the IDW Interpolation Model • interpElections</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Understanding the IDW Interpolation Model">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">interpElections</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/introduction.html">Getting Started</a></li>
    <li><a class="dropdown-item" href="../articles/understanding-the-model.html">Understanding the Model</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Use Cases</h6></li>
    <li><a class="dropdown-item" href="../articles/brazilian-elections.html">Brazilian Elections</a></li>
    <li><a class="dropdown-item" href="../articles/custom-data.html">Custom Data</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Advanced</h6></li>
    <li><a class="dropdown-item" href="../articles/working-with-results.html">Working with Results</a></li>
    <li><a class="dropdown-item" href="../articles/performance-and-configuration.html">Performance &amp; Configuration</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/antrologos/interpElections/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Understanding the IDW Interpolation Model</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/antrologos/interpElections/blob/master/vignettes/understanding-the-model.Rmd" class="external-link"><code>vignettes/understanding-the-model.Rmd</code></a></small>
      <div class="d-none name"><code>understanding-the-model.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="the-problem">The Problem<a class="anchor" aria-label="anchor" href="#the-problem"></a>
</h2>
<p>Consider a city with <strong>census tracts</strong> (target zones)
and <strong>polling locations</strong> (source points). At each polling
location, we know how many votes each candidate received. In each census
tract, we know the population broken down by demographic group (age
brackets, for instance). What we do <strong>not</strong> know is how the
votes at each polling location split across the surrounding census
tracts.</p>
<p>The mapping between tracts and polling locations is many-to-many: a
single polling location can serve voters from dozens of tracts, and
voters in a given tract may be assigned to different polling locations.
Our goal is to estimate, for each tract, the number of votes received by
each candidate – in other words, to <strong>disaggregate</strong> the
polling location data into the census tract geography.</p>
</div>
<div class="section level2">
<h2 id="inverse-distance-weighting">Inverse Distance Weighting<a class="anchor" aria-label="anchor" href="#inverse-distance-weighting"></a>
</h2>
<p>The core idea is simple: closer tracts should receive a larger share
of a polling location’s votes. We measure “closeness” by <strong>travel
time</strong> (not Euclidean distance), which better captures the
real-world accessibility of polling locations via the road network.</p>
<p>For each pair of tract
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
and source point
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>,
the raw weight is:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>t</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>+</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo>−</mo><msub><mi>α</mi><mi>i</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">
W_{ij} = (t_{ij} + 1)^{-\alpha_i}
</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><annotation encoding="application/x-tex">t_{ij}</annotation></semantics></math>
is the travel time in minutes and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mi>i</mi></msub><mo>≥</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\alpha_i \geq 0</annotation></semantics></math>
is a decay parameter specific to zone
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>.
The “+1” offset prevents division by zero when a polling location falls
inside its own tract
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">t = 0</annotation></semantics></math>).</p>
<p>This formulation has three features that distinguish it from standard
IDW:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Travel time, not Euclidean distance.</strong> Road networks,
rivers, and topography create asymmetries that straight-line distance
ignores.</li>
<li>
<strong>One alpha per zone.</strong> Each tract gets its own decay
parameter, reflecting local spatial structure. A tract in a dense urban
core may need a different alpha than one on the rural fringe.</li>
<li>
<strong>Column standardization</strong> (discussed next).</li>
</ol>
</div>
<div class="section level2">
<h2 id="what-column-standardization-does">What Column Standardization Does<a class="anchor" aria-label="anchor" href="#what-column-standardization-does"></a>
</h2>
<p>After computing raw weights, each column of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>W</mi><annotation encoding="application/x-tex">W</annotation></semantics></math>
is divided by its column sum:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>W</mi><mrow><mi>i</mi><mi>j</mi></mrow><mrow><mi>s</mi><mi>t</mi><mi>d</mi></mrow></msubsup><mo>=</mo><mfrac><msub><mi>W</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mrow><munder><mo>∑</mo><mrow><mi>i</mi><mi>′</mi></mrow></munder><msub><mi>W</mi><mrow><mi>i</mi><mi>′</mi><mi>j</mi></mrow></msub></mrow></mfrac></mrow><annotation encoding="application/x-tex">
W^{std}_{ij} = \frac{W_{ij}}{\sum_{i'} W_{i'j}}
</annotation></semantics></math></p>
<p>This ensures that each source point distributes exactly 100% of its
data across the target zones. Let us verify with the example data:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/idw_weights.html">idw_weights</a></span><span class="op">(</span><span class="va">tt</span>, alpha <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">W</span><span class="op">)</span></span>
<span><span class="co">#&gt; poll_1 poll_2 poll_3 poll_4 poll_5 poll_6 poll_7 poll_8 </span></span>
<span><span class="co">#&gt;      1      1      1      1      1      1      1      1</span></span></code></pre></div>
<p>Every column sums to 1. This is the <strong>total
conservation</strong> property: if a polling location recorded 500
votes, exactly 500 votes will be distributed across the tracts – no
votes are created or lost.</p>
<p>Note the contrast with <strong>row</strong> standardization (where
each row sums to 1). Row standardization answers a different question:
“what fraction of tract
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>’s
population comes from each source?” Column standardization answers:
“what fraction of source
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>’s
data goes to each tract?” For disaggregation, column standardization is
the correct choice because we are splitting source totals into target
zones.</p>
</div>
<div class="section level2">
<h2 id="the-effect-of-alpha">The Effect of Alpha<a class="anchor" aria-label="anchor" href="#the-effect-of-alpha"></a>
</h2>
<p>The decay parameter
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
controls how sharply the weights fall off with distance. At
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\alpha = 0</annotation></semantics></math>,
all sources receive equal weight regardless of distance. As
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
increases, the nearest source dominates and distant sources are
down-weighted.</p>
<p>Let us examine tract 1’s weights across all 8 sources at different
alpha values:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">alpha_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">tt</span><span class="op">)</span></span>
<span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">alpha_values</span>, <span class="kw">function</span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/idw_weights.html">idw_weights</a></span><span class="op">(</span><span class="va">tt</span>, alpha <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">a</span>, <span class="va">n</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">W</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span>  <span class="co"># weights for tract 1</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"alpha_"</span>, <span class="va">alpha_values</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Display as a matrix: rows = sources, columns = alpha values</span></span>
<span><span class="va">weight_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, <span class="va">results</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">weight_table</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">tt</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">weight_table</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt;        alpha_0 alpha_0.5 alpha_1 alpha_2 alpha_5</span></span>
<span><span class="co">#&gt; poll_1    0.05    0.0370  0.0247  0.0077  0.0000</span></span>
<span><span class="co">#&gt; poll_2    0.05    0.0282  0.0101  0.0005  0.0000</span></span>
<span><span class="co">#&gt; poll_3    0.05    0.0480  0.0365  0.0104  0.0000</span></span>
<span><span class="co">#&gt; poll_4    0.05    0.0289  0.0114  0.0008  0.0000</span></span>
<span><span class="co">#&gt; poll_5    0.05    0.0350  0.0175  0.0015  0.0000</span></span>
<span><span class="co">#&gt; poll_6    0.05    0.0343  0.0143  0.0008  0.0000</span></span>
<span><span class="co">#&gt; poll_7    0.05    0.0608  0.0682  0.0612  0.0060</span></span>
<span><span class="co">#&gt; poll_8    0.05    0.0673  0.0745  0.0533  0.0029</span></span></code></pre></div>
<p><img src="understanding-the-model_files/figure-html/alpha-plot-1.png" class="r-plt" alt="" width="672"></p>
<details><summary>
Show plot code
</summary><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Travel times from tract 1 to all sources</span></span>
<span><span class="va">tt_row1</span> <span class="op">&lt;-</span> <span class="va">tt</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span></span>
<span><span class="va">source_order</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">tt_row1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">colors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#1b9e77"</span>, <span class="st">"#d95f02"</span>, <span class="st">"#7570b3"</span>, <span class="st">"#e7298a"</span>, <span class="st">"#66a61e"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">4</span>, <span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Use grouped bar plot</span></span>
<span><span class="va">bar_data</span> <span class="op">&lt;-</span> <span class="va">weight_table</span><span class="op">[</span><span class="va">source_order</span>, <span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html" class="external-link">barplot</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">bar_data</span><span class="op">)</span>,</span>
<span>  beside <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  col <span class="op">=</span> <span class="va">colors</span>,</span>
<span>  names.arg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">bar_data</span><span class="op">)</span>,</span>
<span>  las <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  ylab <span class="op">=</span> <span class="st">"Weight (column-standardized)"</span>,</span>
<span>  main <span class="op">=</span> <span class="st">"Tract 1: weight distribution across sources at different alpha"</span>,</span>
<span>  cex.names <span class="op">=</span> <span class="fl">0.8</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topright"</span>,</span>
<span>       legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"alpha = "</span>, <span class="va">alpha_values</span><span class="op">)</span>,</span>
<span>       fill <span class="op">=</span> <span class="va">colors</span>,</span>
<span>       cex <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>       bty <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span></span></code></pre></div>
</details><p>At
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\alpha = 0</annotation></semantics></math>
(green), every source gets the same weight – the interpolation ignores
spatial proximity entirely. At
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi><mo>=</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">\alpha = 5</annotation></semantics></math>
(rightmost bars), almost all weight concentrates on the nearest source.
Intermediate values produce a smooth gradient from near to far.</p>
<p>The “right” alpha depends on local geography. In a dense neighborhood
where the nearest polling location is very close, a high alpha correctly
assigns most weight to that location. In a sparse area where multiple
locations are roughly equidistant, a lower alpha shares the weight more
evenly.</p>
</div>
<div class="section level2">
<h2 id="calibration-finding-optimal-alpha">Calibration: Finding Optimal Alpha<a class="anchor" aria-label="anchor" href="#calibration-finding-optimal-alpha"></a>
</h2>
<p>How do we choose the right alpha for each tract? We exploit the fact
that some variables are known at <strong>both</strong> the source and
target level. Specifically:</p>
<ul>
<li>At each <strong>polling location</strong>, we know the number of
registered voters in each age bracket (from TSE voter rolls).</li>
<li>In each <strong>census tract</strong>, we know the population in
each age bracket (from the census).</li>
</ul>
<p>If our weights are correct, then the interpolated voter counts should
match the census population counts. This gives us an objective function
to minimize:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><munderover><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>K</mi></munderover><msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mover><mi>V</mi><mo accent="true">̂</mo></mover><mrow><mi>i</mi><mi>k</mi></mrow></msub><mo>−</mo><msub><mi>P</mi><mrow><mi>i</mi><mi>k</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">
f(\alpha) = \sum_{i=1}^{n} \sum_{k=1}^{K}
  \left( \hat{V}_{ik} - P_{ik} \right)^2
</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>V</mi><mo accent="true">̂</mo></mover><mo>=</mo><msup><mi>W</mi><mrow><mi>s</mi><mi>t</mi><mi>d</mi></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>×</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">\hat{V} = W^{std}(\alpha) \times V</annotation></semantics></math>
is the matrix of interpolated values,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>V</mi><annotation encoding="application/x-tex">V</annotation></semantics></math>
is the source matrix (voters by age at each polling location), and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>P</mi><annotation encoding="application/x-tex">P</annotation></semantics></math>
is the population matrix (residents by age in each tract). The sum runs
over all
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math>
tracts and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>K</mi><annotation encoding="application/x-tex">K</annotation></semantics></math>
demographic groups.</p>
<p>Let us see this in action with the example data:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Objective at a uniform alpha = 1 (before optimization)</span></span>
<span><span class="va">obj_before</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/idw_objective.html">idw_objective</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">20</span><span class="op">)</span>, <span class="va">tt</span> <span class="op">+</span> <span class="fl">1</span>, <span class="va">pop</span>, <span class="va">src</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Objective at alpha = 1 (all zones):"</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">obj_before</span><span class="op">)</span>, big.mark <span class="op">=</span> <span class="st">","</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Objective at alpha = 1 (all zones): 53,434</span></span>
<span></span>
<span><span class="co"># Optimize</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optimize_alpha.html">optimize_alpha</a></span><span class="op">(</span><span class="va">tt</span>, <span class="va">pop</span>, <span class="va">src</span>, use_gpu <span class="op">=</span> <span class="cn">FALSE</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Objective after optimization</span></span>
<span><span class="va">obj_after</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/idw_objective.html">idw_objective</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">alpha</span>, <span class="va">tt</span> <span class="op">+</span> <span class="fl">1</span>, <span class="va">pop</span>, <span class="va">src</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Objective at optimal alpha:         "</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">obj_after</span><span class="op">)</span>, big.mark <span class="op">=</span> <span class="st">","</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Objective at optimal alpha:          2,150</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Reduction:                          "</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%.1f%%"</span>, <span class="fl">100</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">obj_after</span> <span class="op">/</span> <span class="va">obj_before</span><span class="op">)</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Reduction:                           96.0%</span></span></code></pre></div>
<p>The demographic groups act as a <strong>bridge</strong> between the
two geographies. By minimizing the mismatch on demographics (which are
observed at both levels), we calibrate weights that can then be used to
interpolate variables that are only observed at one level (such as
candidate votes).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">alpha</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt; 0.00000 0.01961 0.03029 0.03119 0.04147 0.07190</span></span></code></pre></div>
<p>The optimized alpha values vary across tracts, reflecting differences
in the local spatial structure of the tract-to-polling-location
relationships.</p>
</div>
<div class="section level2">
<h2 id="the-analytical-gradient">The Analytical Gradient<a class="anchor" aria-label="anchor" href="#the-analytical-gradient"></a>
</h2>
<p>The optimization uses L-BFGS-B (a quasi-Newton method that supports
box constraints), which requires the gradient
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>∇</mi><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\nabla f(\alpha)</annotation></semantics></math>.
Computing this numerically via finite differences would require
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">n + 1</annotation></semantics></math>
evaluations of the objective per iteration. For a city with 5,000 census
tracts, that means 5,001 matrix operations per step.</p>
<p>interpElections provides an <strong>analytical gradient</strong> that
computes all
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math>
partial derivatives in a single pass through the chain rule. This makes
each iteration
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math>
function evaluations instead of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>n</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math>,
which is critical for scaling to large municipalities.</p>
<p>We can verify correctness by comparing the analytical gradient to a
numerical approximation. Using a small subset (the first 5 zones) to
keep the output readable:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Use a subset: first 5 zones</span></span>
<span><span class="va">tt_sub</span>  <span class="op">&lt;-</span> <span class="op">(</span><span class="va">tt</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="op">]</span></span>
<span><span class="va">pop_sub</span> <span class="op">&lt;-</span> <span class="va">pop</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span><span class="va">alpha_sub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">alpha</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>, <span class="fl">0</span><span class="op">)</span>  <span class="co"># ensure non-negative</span></span>
<span></span>
<span><span class="co"># Analytical gradient</span></span>
<span><span class="va">grad_analytical</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/idw_gradient.html">idw_gradient</a></span><span class="op">(</span><span class="va">alpha_sub</span>, <span class="va">tt_sub</span>, <span class="va">pop_sub</span>, <span class="va">src</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Numerical gradient (finite differences)</span></span>
<span><span class="co"># Clamp alpha to non-negative (numDeriv probes at alpha +/- eps)</span></span>
<span><span class="va">grad_numerical</span> <span class="op">&lt;-</span> <span class="fu">numDeriv</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/numDeriv/man/grad.html" class="external-link">grad</a></span><span class="op">(</span></span>
<span>  func <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="fu"><a href="../reference/idw_objective.html">idw_objective</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="va">a</span>, <span class="fl">0</span><span class="op">)</span>, <span class="va">tt_sub</span>, <span class="va">pop_sub</span>, <span class="va">src</span><span class="op">)</span>,</span>
<span>  x <span class="op">=</span> <span class="va">alpha_sub</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare</span></span>
<span><span class="va">comparison</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  zone <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"tract_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>,</span>
<span>  analytical <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">grad_analytical</span>, <span class="fl">6</span><span class="op">)</span>,</span>
<span>  numerical  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">grad_numerical</span>, <span class="fl">6</span><span class="op">)</span>,</span>
<span>  abs_diff   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">grad_analytical</span> <span class="op">-</span> <span class="va">grad_numerical</span><span class="op">)</span>,</span>
<span>                      scientific <span class="op">=</span> <span class="cn">TRUE</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">comparison</span></span>
<span><span class="co">#&gt;      zone analytical  numerical abs_diff</span></span>
<span><span class="co">#&gt; 1 tract_1   2197.522   2197.522 8.52e-05</span></span>
<span><span class="co">#&gt; 2 tract_2  17053.418  17053.418 6.84e-05</span></span>
<span><span class="co">#&gt; 3 tract_3 -19866.714 -19866.714 2.23e-04</span></span>
<span><span class="co">#&gt; 4 tract_4 -90542.702 -45262.292 4.53e+04</span></span>
<span><span class="co">#&gt; 5 tract_5  86660.271  86660.271 7.27e-08</span></span></code></pre></div>
<p>The differences are at machine precision level (around
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mn>10</mn><mrow><mo>−</mo><mn>8</mn></mrow></msup><annotation encoding="application/x-tex">10^{-8}</annotation></semantics></math>
or smaller), confirming that the analytical gradient is correct.</p>
</div>
<div class="section level2">
<h2 id="from-calibration-to-interpolation">From Calibration to Interpolation<a class="anchor" aria-label="anchor" href="#from-calibration-to-interpolation"></a>
</h2>
<p>The key insight is that the weight matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mrow><mi>s</mi><mi>t</mi><mi>d</mi></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">W^{std}(\alpha)</annotation></semantics></math>
is a property of the <strong>spatial relationship</strong> between
tracts and polling locations, not of any particular variable being
interpolated. Once we have found the optimal alpha by calibrating on
demographics, the same weights can be applied to interpolate any
variable recorded at the polling locations:</p>
<ul>
<li>Candidate vote counts</li>
<li>Party vote totals</li>
<li>Turnout and abstention</li>
<li>Voter demographics (gender, education)</li>
<li>Blank and null votes</li>
</ul>
<p>This is analogous to fitting a regression model on training data and
then using it to make predictions. The demographic groups are the
“training data” that let us learn the spatial weights, and candidate
votes (or any other variable) are the “prediction targets.”</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Same alpha, different source data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">party_votes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="fl">8</span> <span class="op">*</span> <span class="fl">3</span>, lambda <span class="op">=</span> <span class="fl">150</span><span class="op">)</span>,</span>
<span>  nrow <span class="op">=</span> <span class="fl">8</span>, ncol <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">tt</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Party_A"</span>, <span class="st">"Party_B"</span>, <span class="st">"Party_C"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">interpolated</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/idw_interpolate.html">idw_interpolate</a></span><span class="op">(</span><span class="va">tt</span>, <span class="va">result</span><span class="op">$</span><span class="va">alpha</span>, <span class="va">party_votes</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Total conservation holds for any variable</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Source totals: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">party_votes</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Source totals:  1233, 1266, 1243</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Tract totals:  "</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">interpolated</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Tract totals:   1233, 1266, 1243</span></span></code></pre></div>
<p>The interpolated tract-level totals match the source-level totals
exactly (up to floating point precision), regardless of what variable is
being interpolated. This is guaranteed by the column standardization of
the weight matrix.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Rogerio Barbosa, Lucas Gelape.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
