<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Performance Tuning and Configuration • interpElections</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Performance Tuning and Configuration">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">interpElections</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/introduction.html">Getting Started</a></li>
    <li><a class="dropdown-item" href="../articles/understanding-the-model.html">Understanding the Model</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Use Cases</h6></li>
    <li><a class="dropdown-item" href="../articles/brazilian-elections.html">Brazilian Elections</a></li>
    <li><a class="dropdown-item" href="../articles/custom-data.html">Custom Data</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Advanced</h6></li>
    <li><a class="dropdown-item" href="../articles/working-with-results.html">Working with Results</a></li>
    <li><a class="dropdown-item" href="../articles/performance-and-configuration.html">Performance &amp; Configuration</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/antrologos/interpElections/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Performance Tuning and Configuration</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/antrologos/interpElections/blob/master/vignettes/performance-and-configuration.Rmd" class="external-link"><code>vignettes/performance-and-configuration.Rmd</code></a></small>
      <div class="d-none name"><code>performance-and-configuration.Rmd</code></div>
    </div>

    
    
<p>This vignette covers how to configure GPU acceleration, tune
optimization parameters, and manage the package’s file cache.</p>
<div class="section level2">
<h2 id="gpu-setup">GPU Setup<a class="anchor" aria-label="anchor" href="#gpu-setup"></a>
</h2>
<p>interpElections can accelerate alpha optimization using a GPU via the
torch R package. The <code><a href="../reference/check_torch.html">check_torch()</a></code> function runs a
comprehensive diagnostic:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://antrologos.github.io/interpElections/">interpElections</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/check_torch.html">check_torch</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>On a system with a working NVIDIA GPU, the output looks like:</p>
<pre><code>[ok] torch package installed (v0.13.0)
[ok] libtorch + lantern binaries installed
[ok] NVIDIA GPU: NVIDIA GeForce RTX 4090 (24576 MB VRAM)
     Driver: 555.42.02 | Max CUDA: 12.5
[ok] CUDA runtime 12.1 (1 device)
     Compute capability: 8.9 | cuDNN: 9.1.0
[ok] GPU tensor test: passed (cuda)

All checks passed. GPU acceleration is ready.
  Device: cuda | Enable with: use_gpu(TRUE)</code></pre>
<p>If torch is not yet installed, <code><a href="../reference/setup_torch.html">setup_torch()</a></code> handles the
full installation – the R package from CRAN and the platform-appropriate
libtorch/lantern binaries with GPU support:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/setup_torch.html">setup_torch</a></span><span class="op">(</span><span class="op">)</span>              <span class="co"># auto-detect GPU type</span></span>
<span><span class="fu"><a href="../reference/setup_torch.html">setup_torch</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"cuda"</span><span class="op">)</span> <span class="co"># force CUDA binaries</span></span></code></pre></div>
<p>After setup, enable GPU acceleration globally:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/use_gpu.html">use_gpu</a></span><span class="op">(</span>enable <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Or enable it for a single call:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optimize_alpha.html">optimize_alpha</a></span><span class="op">(</span><span class="va">tt</span>, <span class="va">pop</span>, <span class="va">src</span>, use_gpu <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="gpu-vs-cpu-when-to-use-which">GPU vs CPU: When to Use Which<a class="anchor" aria-label="anchor" href="#gpu-vs-cpu-when-to-use-which"></a>
</h2>
<p>The GPU path uses the torch ADAM optimizer with automatic
differentiation, while the CPU path uses L-BFGS-B (optionally
parallelized across cores). The best choice depends on problem size:</p>
<table class="table">
<colgroup>
<col width="33%">
<col width="33%">
<col width="33%">
</colgroup>
<thead><tr class="header">
<th>Problem size (zones)</th>
<th>Recommended</th>
<th>Notes</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>&lt; 200</td>
<td>CPU</td>
<td>Overhead of transferring data to GPU exceeds the speedup.</td>
</tr>
<tr class="even">
<td>200 – 1,000</td>
<td>Either</td>
<td>GPU may be slightly faster; CPU is reliable.</td>
</tr>
<tr class="odd">
<td>1,000 – 10,000</td>
<td>GPU preferred</td>
<td>GPU parallelism provides clear speedup.</td>
</tr>
<tr class="even">
<td>&gt; 10,000</td>
<td>GPU strongly recommended</td>
<td>CPU optimization becomes very slow; GPU handles tens of thousands of
zones well.</td>
</tr>
</tbody>
</table>
<p><strong>GPU requirements:</strong></p>
<ul>
<li>
<strong>NVIDIA</strong>: CUDA-capable GPU with a recent driver.
Compute capability 3.7 or higher (Maxwell and newer). Works on Windows
and Linux.</li>
<li>
<strong>Apple Silicon</strong>: MPS backend on macOS with
M1/M2/M3/M4 chips. Requires torch &gt;= 0.12 and macOS 12.3+.</li>
<li>
<strong>No GPU</strong>: The CPU fallback works on any platform. It
is the default when <code>use_gpu = FALSE</code> or when no GPU is
detected.</li>
</ul>
</div>
<div class="section level2">
<h2 id="optimization-parameters">Optimization Parameters<a class="anchor" aria-label="anchor" href="#optimization-parameters"></a>
</h2>
<div class="section level3">
<h3 id="cpu-optimization">CPU optimization<a class="anchor" aria-label="anchor" href="#cpu-optimization"></a>
</h3>
<p>Load the bundled example data and run the optimizer with default
settings:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://antrologos.github.io/interpElections/">interpElections</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; interpElections: some optional dependencies are missing:</span></span>
<span><span class="co">#&gt; - No OSM clipping tool found (osmium/osmconvert)</span></span>
<span><span class="co">#&gt;   Install with: interpElections::setup_osmium()</span></span>
<span><span class="co">#&gt; These are needed for the full interpolation pipeline.</span></span>
<span></span>
<span><span class="va">tt</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/example_tt_matrix.rds"</span>,</span>
<span>                            package <span class="op">=</span> <span class="st">"interpElections"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/example_pop_matrix.rds"</span>,</span>
<span>                            package <span class="op">=</span> <span class="st">"interpElections"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">src</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/example_source_matrix.rds"</span>,</span>
<span>                            package <span class="op">=</span> <span class="st">"interpElections"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">result_default</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optimize_alpha.html">optimize_alpha</a></span><span class="op">(</span><span class="va">tt</span>, <span class="va">pop</span>, <span class="va">src</span>,</span>
<span>                                  use_gpu <span class="op">=</span> <span class="cn">FALSE</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Inspect convergence information:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result_default</span><span class="op">$</span><span class="va">method</span></span>
<span><span class="co">#&gt; [1] "cpu_lbfgsb"</span></span>
<span><span class="va">result_default</span><span class="op">$</span><span class="va">convergence</span>   <span class="co"># 0 = success</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="va">result_default</span><span class="op">$</span><span class="va">message</span></span>
<span><span class="co">#&gt; [1] "CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH"</span></span>
<span><span class="va">result_default</span><span class="op">$</span><span class="va">iterations</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;       58       58</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Elapsed:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">result_default</span><span class="op">$</span><span class="va">elapsed</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Elapsed: 0.4363866 secs</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Objective:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">result_default</span><span class="op">$</span><span class="va">value</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Objective: 2150.05</span></span></code></pre></div>
<p><strong>CPU cascade.</strong> When <code>cpu_method = "auto"</code>
(the default), the optimizer tries methods in order:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Parallel L-BFGS-B</strong> via <code>optimParallel</code> –
uses multiple CPU cores. Requires the <code>optimParallel</code> and
<code>parallel</code> packages.</li>
<li>
<strong>Serial L-BFGS-B</strong> – standard <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim()</a></code>
with box constraints.</li>
<li>
<strong>BFGS</strong> – unconstrained fallback (bounds enforced via
clamping).</li>
</ol>
<p>Each method is tried only if the previous one fails. Most problems
converge on the first attempt.</p>
</div>
<div class="section level3">
<h3 id="effect-of-bounds">Effect of bounds<a class="anchor" aria-label="anchor" href="#effect-of-bounds"></a>
</h3>
<p>By default, alpha values are bounded between 0 and 20. Narrowing the
bounds can speed up convergence and prevent extreme values:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result_narrow</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optimize_alpha.html">optimize_alpha</a></span><span class="op">(</span><span class="va">tt</span>, <span class="va">pop</span>, <span class="va">src</span>,</span>
<span>                                 use_gpu <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                 lower_bound <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>                                 upper_bound <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                                 verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Default bounds [0, 20] -- objective:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">result_default</span><span class="op">$</span><span class="va">value</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Default bounds [0, 20] -- objective: 2150.05</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Narrow bounds [0.5, 5] -- objective:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">result_narrow</span><span class="op">$</span><span class="va">value</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Narrow bounds [0.5, 5] -- objective: 2312.95</span></span></code></pre></div>
<p><img src="performance-and-configuration_files/figure-html/plot-bounds-comparison-1.png" class="r-plt" alt="" width="672"></p>
<details><summary>
Show plot code
</summary><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span>, <span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">result_default</span><span class="op">$</span><span class="va">alpha</span>, breaks <span class="op">=</span> <span class="fl">10</span>, col <span class="op">=</span> <span class="st">"#4E79A7"</span>, border <span class="op">=</span> <span class="st">"white"</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"Default bounds [0, 20]"</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"Alpha"</span>, ylab <span class="op">=</span> <span class="st">"Frequency"</span>,</span>
<span>     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">result_default</span><span class="op">$</span><span class="va">alpha</span>, <span class="va">result_narrow</span><span class="op">$</span><span class="va">alpha</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">result_narrow</span><span class="op">$</span><span class="va">alpha</span>, breaks <span class="op">=</span> <span class="fl">10</span>, col <span class="op">=</span> <span class="st">"#E15759"</span>, border <span class="op">=</span> <span class="st">"white"</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"Narrow bounds [0.5, 5]"</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"Alpha"</span>, ylab <span class="op">=</span> <span class="st">"Frequency"</span>,</span>
<span>     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">result_default</span><span class="op">$</span><span class="va">alpha</span>, <span class="va">result_narrow</span><span class="op">$</span><span class="va">alpha</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</details><p>Narrow bounds constrain the alpha distribution but may increase the
objective value (worse fit). Use narrow bounds when you have prior
knowledge about the expected decay behavior, or when you want to prevent
extreme solutions.</p>
</div>
<div class="section level3">
<h3 id="gpu-parameters">GPU parameters<a class="anchor" aria-label="anchor" href="#gpu-parameters"></a>
</h3>
<p>When <code>use_gpu = TRUE</code>, the optimizer uses the torch ADAM
algorithm with a learning rate schedule. The key parameters are:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optimize_alpha.html">optimize_alpha</a></span><span class="op">(</span></span>
<span>  <span class="va">tt</span>, <span class="va">pop</span>, <span class="va">src</span>,</span>
<span>  use_gpu        <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  device         <span class="op">=</span> <span class="st">"cuda"</span>,     <span class="co"># or "mps" for Apple Silicon</span></span>
<span>  dtype          <span class="op">=</span> <span class="st">"float32"</span>,  <span class="co"># or "float64" for higher precision</span></span>
<span>  gpu_iterations <span class="op">=</span> <span class="fl">20</span>,         <span class="co"># number of ADAM phases (outer iterations)</span></span>
<span>  gpu_lr_init    <span class="op">=</span> <span class="fl">0.1</span>,        <span class="co"># initial learning rate</span></span>
<span>  gpu_lr_decay   <span class="op">=</span> <span class="fl">0.6</span>         <span class="co"># decay factor per phase</span></span>
<span><span class="op">)</span></span></code></pre></div>
<ul>
<li><p><strong><code>gpu_iterations</code></strong>: Each “phase” runs a
full ADAM optimization pass. The learning rate is reduced by
<code>gpu_lr_decay</code> after each phase. More phases allow finer
convergence. Default: 20.</p></li>
<li><p><strong><code>gpu_lr_init</code></strong>: Starting learning
rate. Larger values explore faster but risk overshooting. Default:
0.1.</p></li>
<li><p><strong><code>gpu_lr_decay</code></strong>: Multiplicative decay
applied each phase. A value of 0.6 means the learning rate after phase k
is <code>gpu_lr_init * 0.6^k</code>. Default: 0.6.</p></li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="float32-vs-float64">float32 vs float64<a class="anchor" aria-label="anchor" href="#float32-vs-float64"></a>
</h2>
<p>The <code>dtype</code> parameter controls numerical precision on the
GPU:</p>
<table class="table">
<colgroup>
<col width="20%">
<col width="20%">
<col width="20%">
<col width="20%">
<col width="20%">
</colgroup>
<thead><tr class="header">
<th>dtype</th>
<th>Precision</th>
<th>Memory</th>
<th>Speed</th>
<th>Use case</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>float32</code></td>
<td>Single precision</td>
<td>1x</td>
<td>Faster</td>
<td>Default; good balance of speed and accuracy for most problems</td>
</tr>
<tr class="even">
<td><code>float64</code></td>
<td>Full double precision</td>
<td>2x</td>
<td>Slower</td>
<td>When maximum numerical precision is needed</td>
</tr>
</tbody>
</table>
<p>The default is <code>float32</code>, which provides sufficient
precision for most municipal-scale problems while using less GPU memory.
Switch to <code>float64</code> if you need maximum accuracy, or keep
<code>float32</code> when VRAM is tight or you need maximum
throughput:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Global setting for higher precision</span></span>
<span><span class="fu"><a href="../reference/use_gpu.html">use_gpu</a></span><span class="op">(</span>enable <span class="op">=</span> <span class="cn">TRUE</span>, dtype <span class="op">=</span> <span class="st">"float64"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Or per-call</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optimize_alpha.html">optimize_alpha</a></span><span class="op">(</span><span class="va">tt</span>, <span class="va">pop</span>, <span class="va">src</span>, use_gpu <span class="op">=</span> <span class="cn">TRUE</span>, dtype <span class="op">=</span> <span class="st">"float64"</span><span class="op">)</span></span></code></pre></div>
<p>The CPU optimizer always uses <code>float64</code> (R’s native double
precision).</p>
</div>
<div class="section level2">
<h2 id="java-and-r5r-setup">Java and r5r Setup<a class="anchor" aria-label="anchor" href="#java-and-r5r-setup"></a>
</h2>
<p>Travel time computation requires the <code>r5r</code> package and a
Java Development Kit (JDK) version 21 or higher.</p>
<div class="section level3">
<h3 id="diagnostics">Diagnostics<a class="anchor" aria-label="anchor" href="#diagnostics"></a>
</h3>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/check_r5r.html">check_r5r</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Sample output on a correctly configured system:</p>
<pre><code>[ok] r5r package installed (v2.1)
[ok] Java 21 found
[ok] Java max heap: 4g
     System RAM: 16 GB

All checks passed. r5r is ready to use.</code></pre>
</div>
<div class="section level3">
<h3 id="installing-java">Installing Java<a class="anchor" aria-label="anchor" href="#installing-java"></a>
</h3>
<p>If Java is missing or the wrong version, <code><a href="../reference/setup_java.html">setup_java()</a></code>
downloads and configures Adoptium Temurin JDK 21 automatically:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/setup_java.html">setup_java</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>This downloads the JDK for your platform, extracts it to a local
directory, sets <code>JAVA_HOME</code>, and optionally persists the
setting in <code>~/.Renviron</code>.</p>
</div>
<div class="section level3">
<h3 id="osm-clipping-tool">OSM clipping tool<a class="anchor" aria-label="anchor" href="#osm-clipping-tool"></a>
</h3>
<p>The travel time pipeline clips OpenStreetMap data to the study area
before building the routing network. This requires
<code>osmium-tool</code>:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/setup_osmium.html">setup_osmium</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>This searches for <code>osmium</code> on the system and, if not
found, downloads a platform-appropriate binary.</p>
</div>
<div class="section level3">
<h3 id="memory-configuration">Memory configuration<a class="anchor" aria-label="anchor" href="#memory-configuration"></a>
</h3>
<p>Large travel time matrices (e.g., 10,000+ zones with 500+ sources)
can require several gigabytes of JVM heap. Configure this
<strong>before</strong> loading r5r:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set JVM heap to 8 GB</span></span>
<span><span class="fu"><a href="../reference/set_java_memory.html">set_java_memory</a></span><span class="op">(</span><span class="st">"8g"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Rule of thumb: &gt;= 2 GB per million origin-destination pairs</span></span>
<span><span class="co"># 5,000 tracts x 200 sources = 1M pairs -&gt; 2-4 GB</span></span>
<span><span class="co"># 20,000 tracts x 500 sources = 10M pairs -&gt; 8-16 GB</span></span></code></pre></div>
<p>The <code><a href="../reference/set_java_memory.html">set_java_memory()</a></code> function must be called before
<code>r5r</code> (or <code>rJava</code>) is loaded in the R session.
Once the JVM starts, heap size cannot be changed without restarting
R.</p>
</div>
</div>
<div class="section level2">
<h2 id="cache-management">Cache Management<a class="anchor" aria-label="anchor" href="#cache-management"></a>
</h2>
<p>interpElections caches downloaded files and computed artifacts
(travel time matrices, processed electoral data, etc.) to avoid
re-downloading and re-computing across sessions.</p>
<div class="section level3">
<h3 id="viewing-the-cache-directory">Viewing the cache directory<a class="anchor" aria-label="anchor" href="#viewing-the-cache-directory"></a>
</h3>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cache_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_interpElections_cache_dir.html">get_interpElections_cache_dir</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">cache_dir</span></span>
<span><span class="co">#&gt; [1] "/home/runner/.cache/R/interpElections"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="changing-the-cache-directory">Changing the cache directory<a class="anchor" aria-label="anchor" href="#changing-the-cache-directory"></a>
</h3>
<p>You can point the cache to a different location. Here we demonstrate
with a temporary directory:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">old_cache</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_interpElections_cache_dir.html">get_interpElections_cache_dir</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/set_interpElections_cache_dir.html">set_interpElections_cache_dir</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/get_interpElections_cache_dir.html">get_interpElections_cache_dir</a></span><span class="op">(</span><span class="op">)</span>   <span class="co"># now points to temp</span></span>
<span><span class="co">#&gt; [1] "/tmp/RtmpGBOSf4"</span></span>
<span></span>
<span><span class="co"># Restore the original</span></span>
<span><span class="fu"><a href="../reference/set_interpElections_cache_dir.html">set_interpElections_cache_dir</a></span><span class="op">(</span><span class="va">old_cache</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>To reset to the OS default location:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/set_interpElections_cache_dir.html">set_interpElections_cache_dir</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="listing-cached-files">Listing cached files<a class="anchor" aria-label="anchor" href="#listing-cached-files"></a>
</h3>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Per-category summary</span></span>
<span><span class="fu"><a href="../reference/interpElections_cache.html">interpElections_cache</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Detailed listing with individual files</span></span>
<span><span class="fu"><a href="../reference/interpElections_cache.html">interpElections_cache</a></span><span class="op">(</span>details <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="cleaning-the-cache">Cleaning the cache<a class="anchor" aria-label="anchor" href="#cleaning-the-cache"></a>
</h3>
<p>Remove specific categories or the entire cache:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Clear only travel time matrices (forces re-computation next run)</span></span>
<span><span class="fu"><a href="../reference/interpElections_cache_clean.html">interpElections_cache_clean</a></span><span class="op">(</span><span class="st">"travel_times"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Clear all raw downloads</span></span>
<span><span class="fu"><a href="../reference/interpElections_cache_clean.html">interpElections_cache_clean</a></span><span class="op">(</span><span class="st">"downloads"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Clear everything</span></span>
<span><span class="fu"><a href="../reference/interpElections_cache_clean.html">interpElections_cache_clean</a></span><span class="op">(</span><span class="st">"all"</span><span class="op">)</span></span></code></pre></div>
<p>Available categories:</p>
<table class="table">
<colgroup>
<col width="50%">
<col width="50%">
</colgroup>
<thead><tr class="header">
<th>Category</th>
<th>Contents</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>votes</code></td>
<td>TSE vote count ZIPs</td>
</tr>
<tr class="even">
<td><code>turnout</code></td>
<td>TSE turnout data ZIPs</td>
</tr>
<tr class="odd">
<td><code>geocode</code></td>
<td>TSE polling station location ZIPs</td>
</tr>
<tr class="even">
<td><code>profile</code></td>
<td>TSE voter profile ZIPs</td>
</tr>
<tr class="odd">
<td><code>hidalgo</code></td>
<td>Hidalgo geocoding fallback data</td>
</tr>
<tr class="even">
<td><code>osm</code></td>
<td>OpenStreetMap road network extracts</td>
</tr>
<tr class="odd">
<td><code>electoral</code></td>
<td>Processed electoral data</td>
</tr>
<tr class="even">
<td><code>tracts</code></td>
<td>Cached census tract geometries</td>
</tr>
<tr class="odd">
<td><code>r5r</code></td>
<td>r5r routing network indices</td>
</tr>
<tr class="even">
<td><code>travel_times</code></td>
<td>Cached travel time matrices</td>
</tr>
<tr class="odd">
<td><code>downloads</code></td>
<td>All raw downloads (votes + turnout + geocode + profile + hidalgo +
osm)</td>
</tr>
<tr class="even">
<td><code>processed</code></td>
<td>All processed results (electoral + tracts)</td>
</tr>
<tr class="odd">
<td><code>networks</code></td>
<td>All r5r network indices</td>
</tr>
<tr class="even">
<td><code>all</code></td>
<td>The entire cache</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="the-cache-and-force-parameters">The <code>cache</code> and <code>force</code> parameters<a class="anchor" aria-label="anchor" href="#the-cache-and-force-parameters"></a>
</h3>
<p>Most download functions (e.g., <code><a href="../reference/br_download_votes.html">br_download_votes()</a></code>,
<code><a href="../reference/br_download_turnout.html">br_download_turnout()</a></code>) accept two caching parameters:</p>
<ul>
<li>
<strong><code>cache = TRUE</code></strong> (default): Store
downloaded files in the persistent cache. Subsequent calls reuse the
cached file instead of re-downloading.</li>
<li>
<strong><code>force = TRUE</code></strong>: Re-download even if a
cached copy exists. Useful when you suspect a corrupted download or when
upstream data has been updated.</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="troubleshooting">Troubleshooting<a class="anchor" aria-label="anchor" href="#troubleshooting"></a>
</h2>
<div class="section level3">
<h3 id="cuda-not-found">CUDA not found<a class="anchor" aria-label="anchor" href="#cuda-not-found"></a>
</h3>
<p>If <code><a href="../reference/check_torch.html">check_torch()</a></code> reports that CUDA is not available
despite having an NVIDIA GPU:</p>
<ol style="list-style-type: decimal">
<li><p>Verify the GPU driver is installed: run <code>nvidia-smi</code>
in a terminal.</p></li>
<li>
<p>Reinstall torch binaries with CUDA support:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/setup_torch.html">setup_torch</a></span><span class="op">(</span>reinstall <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</li>
<li><p>Restart R after reinstalling – torch binaries are loaded once at
namespace load time.</p></li>
</ol>
</div>
<div class="section level3">
<h3 id="torch-binary-mismatch">torch binary mismatch<a class="anchor" aria-label="anchor" href="#torch-binary-mismatch"></a>
</h3>
<p>If torch was installed with CPU-only binaries (e.g., because CUDA was
not detected at install time), GPU tensor creation will fail. Fix by
reinstalling:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/setup_torch.html">setup_torch</a></span><span class="op">(</span>reinstall <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># Then restart R</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="java-version-mismatch">Java version mismatch<a class="anchor" aria-label="anchor" href="#java-version-mismatch"></a>
</h3>
<p>r5r requires Java 21+. If <code><a href="../reference/check_r5r.html">check_r5r()</a></code> reports an older
version:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/setup_java.html">setup_java</a></span><span class="op">(</span><span class="op">)</span>   <span class="co"># downloads and configures JDK 21</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="r5r-memory-errors">r5r memory errors<a class="anchor" aria-label="anchor" href="#r5r-memory-errors"></a>
</h3>
<p>If r5r crashes with <code>OutOfMemoryError</code>:</p>
<ol style="list-style-type: decimal">
<li>
<p>Increase the JVM heap <strong>before</strong> loading r5r:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/set_java_memory.html">set_java_memory</a></span><span class="op">(</span><span class="st">"8g"</span><span class="op">)</span></span></code></pre></div>
</li>
<li><p>Restart R (the JVM cannot be reconfigured once started).</p></li>
<li><p>If the problem persists, try a larger value (e.g.,
<code>"16g"</code>), keeping in mind your system’s total RAM.</p></li>
</ol>
</div>
<div class="section level3">
<h3 id="slow-cpu-optimization">Slow CPU optimization<a class="anchor" aria-label="anchor" href="#slow-cpu-optimization"></a>
</h3>
<p>If CPU optimization is slow for a large municipality:</p>
<ol style="list-style-type: decimal">
<li>
<p>Ensure <code>optimParallel</code> is installed for parallel
L-BFGS-B:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"optimParallel"</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p>Consider narrowing the bounds to speed convergence:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/optimize_alpha.html">optimize_alpha</a></span><span class="op">(</span><span class="va">tt</span>, <span class="va">pop</span>, <span class="va">src</span>, lower_bound <span class="op">=</span> <span class="fl">0.1</span>, upper_bound <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
</li>
<li><p>For municipalities with more than ~1,000 zones, GPU acceleration
typically provides a significant speedup. See the GPU Setup section
above.</p></li>
</ol>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Rogerio Barbosa, Lucas Gelape.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
