% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/brazil-electoral.R
\name{br_prepare_electoral}
\alias{br_prepare_electoral}
\title{Prepare Brazilian electoral data at the polling-location level}
\usage{
br_prepare_electoral(
  code_muni_ibge,
  code_muni_tse,
  uf,
  year,
  cargo = NULL,
  turno = 1L,
  what = "candidates",
  candidates = NULL,
  parties = NULL,
  perfil_path = NULL,
  comparecimento_path = NULL,
  votacao_path = NULL,
  geocode_path = NULL,
  cache = TRUE,
  force = FALSE,
  verbose = TRUE
)
}
\arguments{
\item{code_muni_ibge}{Character. 7-digit IBGE municipality code
(e.g., \code{"3550308"} for Sao Paulo).}

\item{code_muni_tse}{Character. 5-digit TSE municipality code
(e.g., \code{"71072"} for Sao Paulo). Typically obtained via
\code{\link[=interpolate_election_br]{interpolate_election_br()}}, which resolves this automatically.}

\item{uf}{Character. Two-letter state abbreviation (e.g., \code{"SP"},
\code{"RJ"}, \code{"MG"}).}

\item{year}{Integer. Election year. See \code{\link[=interpolate_election_br]{interpolate_election_br()}}
for the distinction between municipal and general election years.}

\item{cargo}{Integer, character, or NULL. Which electoral office(s) to
include. Accepts human-readable aliases (case-insensitive), TSE
numeric codes, or a vector of either:\tabular{lll}{
   Alias \tab TSE code \tab Election type \cr
   \code{"presidente"} \tab 1 \tab General \cr
   \code{"governador"} \tab 3 \tab General \cr
   \code{"senador"} \tab 5 \tab General \cr
   \code{"deputado_federal"} \tab 6 \tab General \cr
   \code{"deputado_estadual"} \tab 7 \tab General \cr
   \code{"deputado_distrital"} \tab 8 \tab General (DF only) \cr
   \code{"prefeito"} \tab 11 \tab Municipal \cr
   \code{"vereador"} \tab 13 \tab Municipal \cr
}


When \code{NULL} (the default), all offices present in the data file are
included. For general election years, this automatically downloads
the national file for presidential data.

When multiple cargos are selected, output columns are prefixed
(e.g., \verb{PREFEITO_CAND_*}, \verb{VEREADOR_CAND_*}).}

\item{turno}{Integer. Election round: \code{1} (first round, the default)
or \code{2} (runoff). The runoff only exists for presidente, governador,
and prefeito (in cities with >200k voters), and only when no
candidate wins outright in the first round.}

\item{what}{Character vector. Controls what data columns are produced
in the output. One or more of:
\itemize{
\item \code{"candidates"} \strong{(default)}: One column per candidate with their
vote counts, named \verb{CAND_<ballot_number>}. Also includes
\code{QT_COMPARECIMENTO} (total turnout). Special ballot numbers:
95 = blank votes (em branco), 96 = null votes (nulo).
\item \code{"parties"}: One column per party with total votes, named
\verb{PARTY_<abbreviation>} (e.g., \code{PARTY_PT}, \code{PARTY_MDB}).
Also includes \code{QT_COMPARECIMENTO}.
\item \code{"turnout"}: Turnout statistics: \code{QT_COMPARECIMENTO} (voters who
showed up), \code{QT_APTOS} (eligible voters), and \code{QT_ABSTENCOES}
(abstentions), when available in the data.
\item \code{"demographics"}: Voter profile by gender (\code{GENERO_FEMININO},
\code{GENERO_MASCULINO}, \code{GENERO_NAO_INFORMADO}) and education level
(\code{EDUC_ANALFABETO}, \code{EDUC_LE_ESCREVE}, \code{EDUC_FUND_INCOMP},
\code{EDUC_FUND_COMP}, \code{EDUC_MEDIO_INCOMP}, \code{EDUC_MEDIO_COMP},
\code{EDUC_SUP_INCOMP}, \code{EDUC_SUP_COMP}, \code{EDUC_NAO_INFORMADO}).
Note: demographics come from the voter registration profile, not
from vote data, so no \code{cargo} filter applies.
}

Values can be combined:
\code{what = c("candidates", "parties", "turnout", "demographics")}.}

\item{candidates}{Character or numeric vector, or NULL. Filter
specific candidates (only applies when \code{"candidates" \%in\% what}):
\itemize{
\item \strong{Numeric values} match the candidate's ballot number exactly.
Example: \code{candidates = c(13, 22)}.
\item \strong{Character values} perform accent-normalized, case-insensitive
substring matching against the candidate's registered name.
Example: \code{candidates = "LULA"} matches
"LUIZ INACIO LULA DA SILVA".
\item \strong{NULL} (the default): all candidates are kept.
}}

\item{parties}{Character vector or NULL. Filter specific parties
(only applies when \code{"parties" \%in\% what}). Uses official TSE party
abbreviations, matched case-insensitively. Example:
\code{parties = c("PT", "PL", "MDB")}.
\strong{NULL} (the default): all parties are kept.}

\item{perfil_path}{Character or NULL. Path to a local voter profile
CSV file. If NULL (the default), downloads from TSE.}

\item{comparecimento_path}{Character or NULL. Path to attendance
parquet file. If NULL (the default), turnout is computed from the
vote data itself.}

\item{votacao_path}{Character or NULL. Path to candidate votes parquet
file. If NULL (the default), downloads from TSE.}

\item{geocode_path}{Character or NULL. Path to a CSV with geocoded
polling station coordinates (columns: \code{nr_zona},
\code{nr_local_votacao}, \code{lat}, \code{long}). If NULL, coordinates are
obtained from TSE and Danny Hidalgo's geocoding project.}

\item{cache}{Logical. If TRUE (default), downloaded files are stored
persistently. See \code{\link[=get_interpElections_cache_dir]{get_interpElections_cache_dir()}}.}

\item{force}{Logical. Re-download even if cached file exists.
Default: FALSE.}

\item{verbose}{Logical. Print progress messages. Default: TRUE.}
}
\value{
A data frame with one row per \strong{voting location} (not per
polling section). Contains the following column groups:

\strong{Always present:}
\itemize{
\item \code{lat}, \code{long}: Coordinates of the voting location.
\item \code{id}: Sequential integer ID.
\item \code{votantes_18_20}, ..., \code{votantes_65_69}: Registered voters per
age bracket at this location (used as calibration data).
\item \verb{vot_hom_*}, \verb{vot_mul_*}: Registered voters by gender and
age bracket (7 brackets each, 14 columns total). Used as
calibration data for the interpolation.
}

\strong{Conditional on \code{what}:}
\itemize{
\item \code{"candidates"}: \verb{CAND_<number>} columns + \code{QT_COMPARECIMENTO}.
\item \code{"parties"}: \verb{PARTY_<abbrev>} columns + \code{QT_COMPARECIMENTO}.
\item \code{"turnout"}: \code{QT_COMPARECIMENTO}, \code{QT_APTOS}, \code{QT_ABSTENCOES}.
\item \code{"demographics"}: \verb{GENERO_*} and \verb{EDUC_*} columns.
}

When multiple \code{cargo} values are selected, candidate and party
columns are prefixed (e.g., \code{PREFEITO_CAND_45}, \code{VEREADOR_PARTY_PT}).
}
\description{
Downloads TSE voter profile, attendance, and candidate vote data, merges
them with geocoded polling station coordinates, and aggregates to the
voting-location level. Returns a data frame ready for interpolation.
}
\details{
Most users should use \code{\link[=interpolate_election_br]{interpolate_election_br()}} instead, which calls
this function internally and then runs the full interpolation pipeline.
Use \code{br_prepare_electoral()} directly when you need the raw
polling-location data without interpolation.

When \code{votacao_path} and \code{comparecimento_path} are NULL, data is
auto-downloaded from the official TSE open data portal using
\code{\link[=br_download_votes]{br_download_votes()}} and \code{\link[=br_download_turnout]{br_download_turnout()}}.
\subsection{Data sources}{

All data is downloaded from the TSE open data portal at
\verb{https://cdn.tse.jus.br/estatistica/sead/odsele/}.

Presidential vote data (cargo 1) is published in a separate national
file (\verb{votacao_secao_<year>_BR.zip}, ~250 MB) rather than in per-state
files. This function detects when presidential data is needed and
downloads the national file automatically.

Geocoded polling station coordinates come from two sources: official
TSE data (available from ~2020 onwards, with some missing coordinates)
and Danny Hidalgo's geocoding project
(\url{https://github.com/fdhidalgo/geocode_br_polling_stations}), which
covers earlier years. TSE coordinates take priority when available.
}

\subsection{Dependencies}{

Requires \code{dplyr}, \code{tidyr}, \code{data.table}, and \code{stringr} packages.
When reading local parquet files, the \code{arrow} package is also required.
}
}
\examples{
\dontrun{
# ── Basic usage ────────────────────────────────────────────────
# All candidates in the 2020 municipal election for Boa Vista
elec <- br_prepare_electoral(
  code_muni_ibge = "1400100",
  code_muni_tse  = "01120",
  uf = "RR",
  year = 2020,
  what = c("candidates", "turnout")
)

# ── Specific cargo ─────────────────────────────────────────────
# Only the presidential race in 2022
elec <- br_prepare_electoral(
  code_muni_ibge = "3170701",
  code_muni_tse  = "54135",
  uf = "MG",
  year = 2022,
  cargo = "presidente"
)

# ── Filter specific candidates ─────────────────────────────────
# Only Lula and Bolsonaro in the 2022 presidential race
elec <- br_prepare_electoral(
  code_muni_ibge = "3170701",
  code_muni_tse  = "54135",
  uf = "MG",
  year = 2022,
  cargo = "presidente",
  candidates = c(13, 22)
)

# ── Party vote totals ──────────────────────────────────────────
elec <- br_prepare_electoral(
  code_muni_ibge = "3170701",
  code_muni_tse  = "54135",
  uf = "MG",
  year = 2020,
  cargo = "vereador",
  what = "parties",
  parties = c("PT", "MDB", "PL")
)

# ── Voter demographics ─────────────────────────────────────────
elec <- br_prepare_electoral(
  code_muni_ibge = "3170701",
  code_muni_tse  = "54135",
  uf = "MG",
  year = 2022,
  what = "demographics"
)
# -> GENERO_FEMININO, GENERO_MASCULINO, EDUC_SUP_COMP, ...
}

}
\seealso{
\code{\link[=interpolate_election_br]{interpolate_election_br()}} for the one-step wrapper,
\code{\link[=br_download_votes]{br_download_votes()}}, \code{\link[=br_download_turnout]{br_download_turnout()}},
\code{\link[=interpElections_cache]{interpElections_cache()}}

Other Brazil helpers: 
\code{\link{br_prepare_population}()},
\code{\link{br_prepare_tracts}()}
}
\concept{Brazil helpers}
